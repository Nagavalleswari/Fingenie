<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - FinGenie</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <!-- Sidebar Navigation -->
    <div class="sidebar" id="sidebar">
        <!-- Sidebar Header -->
        <div class="sidebar-header">
            <a href="/" class="sidebar-logo">
                <div class="sidebar-logo-icon">
                    <i class="fas fa-coins"></i>
                </div>
                <span class="sidebar-logo-text">FinGenie</span>
            </a>
        </div>

        <!-- Sidebar Menu -->
        <div class="sidebar-menu">
            <div class="menu-section">
                <div class="menu-section-title">Navigation</div>
                <a href="/" class="menu-item">
                    <div class="menu-item-icon"><i class="fas fa-home"></i></div>
                    <span class="menu-item-text">Home</span>
                </a>
                <a href="#" class="menu-item active" onclick="showPage('dashboard', event)">
                    <div class="menu-item-icon"><i class="fas fa-chart-line"></i></div>
                    <span class="menu-item-text">Dashboard</span>
                </a>
                <a href="/chat" class="menu-item">
                    <div class="menu-item-icon"><i class="fas fa-comments"></i></div>
                    <span class="menu-item-text">AI Assistant</span>
                    <span class="menu-item-badge">New</span>
                </a>
                <a href="#analytics" class="menu-item" onclick="showPage('analytics', event)">
                    <div class="menu-item-icon"><i class="fas fa-chart-bar"></i></div>
                    <span class="menu-item-text">Analytics</span>
                </a>
            </div>

            <div class="menu-section">
                <div class="menu-section-title">Finance</div>
                <a href="#budget" class="menu-item" onclick="showPage('budget', event)">
                    <div class="menu-item-icon"><i class="fas fa-wallet"></i></div>
                    <span class="menu-item-text">Budget</span>
                </a>
                <a href="#investments" class="menu-item" onclick="showPage('investments', event)">
                    <div class="menu-item-icon"><i class="fas fa-chart-pie"></i></div>
                    <span class="menu-item-text">Investments</span>
                </a>
                <a href="#transactions" class="menu-item" onclick="showPage('transactions', event)">
                    <div class="menu-item-icon"><i class="fas fa-exchange-alt"></i></div>
                    <span class="menu-item-text">Transactions</span>
                </a>
                <a href="#goals" class="menu-item" onclick="showPage('goals', event)">
                    <div class="menu-item-icon"><i class="fas fa-bullseye"></i></div>
                    <span class="menu-item-text">Goals</span>
                </a>
                <a href="#loans" class="menu-item" onclick="showPage('loans', event)">
                    <div class="menu-item-icon"><i class="fas fa-file-invoice-dollar"></i></div>
                    <span class="menu-item-text">Loans & Debt</span>
                </a>
            </div>

            <div class="menu-section">
                <div class="menu-section-title">Reports</div>
                <a href="#reports" class="menu-item" onclick="showPage('reports', event)">
                    <div class="menu-item-icon"><i class="fas fa-file-alt"></i></div>
                    <span class="menu-item-text">Reports</span>
                </a>
                <a href="#insights" class="menu-item" onclick="showPage('insights', event)">
                    <div class="menu-item-icon"><i class="fas fa-lightbulb"></i></div>
                    <span class="menu-item-text">Insights</span>
                </a>
            </div>

            <div class="menu-section">
                <div class="menu-section-title">Account</div>
                <a href="#profile" class="menu-item" onclick="showPage('profile', event)">
                    <div class="menu-item-icon"><i class="fas fa-user"></i></div>
                    <span class="menu-item-text">Profile</span>
                </a>
                <a href="#settings" class="menu-item" onclick="showPage('settings', event)">
                    <div class="menu-item-icon"><i class="fas fa-cog"></i></div>
                    <span class="menu-item-text">Settings</span>
                </a>
            </div>

            <div class="menu-section">
                <div class="menu-section-title">More</div>
                <a href="#about" class="menu-item" onclick="showPage('about', event)">
                    <div class="menu-item-icon"><i class="fas fa-info-circle"></i></div>
                    <span class="menu-item-text">About</span>
                </a>
                <a href="#help" class="menu-item" onclick="showPage('help', event)">
                    <div class="menu-item-icon"><i class="fas fa-question-circle"></i></div>
                    <span class="menu-item-text">Help & Support</span>
                </a>
                <a href="#privacy" class="menu-item" onclick="showPage('privacy', event)">
                    <div class="menu-item-icon"><i class="fas fa-shield-alt"></i></div>
                    <span class="menu-item-text">Privacy</span>
                </a>
                <a href="#terms" class="menu-item" onclick="showPage('terms', event)">
                    <div class="menu-item-icon"><i class="fas fa-file-contract"></i></div>
                    <span class="menu-item-text">Terms of Service</span>
                </a>
            </div>
        </div>

        <!-- Sidebar Footer -->
        <div class="sidebar-footer">
            <div class="sidebar-user">
                <div class="sidebar-user-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="sidebar-user-info">
                    <div class="sidebar-user-name">User</div>
                    <div class="sidebar-user-email">user@fingenie.com</div>
                </div>
                <i class="fas fa-sign-out-alt" id="logoutBtn" style="cursor: pointer; color: var(--text-tertiary);"></i>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Top Bar -->
        <div class="topbar">
            <div class="topbar-left">
                <button class="topbar-action-btn" id="sidebarToggle" style="display: none;">
                    <i class="fas fa-bars"></i>
                </button>
                <h1 class="topbar-title">Dashboard</h1>
            </div>
            <div class="topbar-right">
                <div class="topbar-search">
                    <i class="fas fa-search topbar-search-icon"></i>
                    <input type="text" class="topbar-search-input" placeholder="Search...">
                </div>
                <div class="topbar-actions">
                    <!-- Theme Toggle -->
                    <div class="theme-toggle" title="Toggle theme">
                        <i class="fas fa-moon theme-toggle-icon moon"></i>
                        <div class="theme-toggle-slider">
                            <i class="fas fa-moon theme-icon"></i>
                        </div>
                        <i class="fas fa-sun theme-toggle-icon sun"></i>
                    </div>
                    <button class="topbar-action-btn">
                        <i class="fas fa-bell"></i>
                        <span class="badge">3</span>
                    </button>
                    <button class="topbar-action-btn">
                        <i class="fas fa-envelope"></i>
                        <span class="badge">5</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Content Container -->
        <div class="content-container">
            <!-- Page Header -->
            <div class="page-header">
                <h2 class="page-title" id="pageTitle">Financial Overview</h2>
                <p class="page-subtitle" id="pageSubtitle">Track your financial health and progress</p>
            </div>

            <!-- Dynamic Content Area - All Pages -->
            <div id="pageContent">
            <!-- Dashboard Content (Default) -->
            <div class="dashboard-content">
            <!-- Stats Grid -->
            <div class="grid grid-cols-4 mb-4">
                <div class="stat-card fade-in">
                    <div class="stat-card-header">
                        <div class="stat-card-icon">
                            <i class="fas fa-wallet"></i>
                        </div>
                        <div class="stat-card-trend up">
                            <i class="fas fa-arrow-up"></i>
                            <span>12.5%</span>
                        </div>
                    </div>
                    <div class="stat-card-value" id="totalAssets">₹0</div>
                    <div class="stat-card-label">Total Assets</div>
                </div>

                <div class="stat-card fade-in" style="animation-delay: 0.1s;">
                    <div class="stat-card-header">
                        <div class="stat-card-icon" style="background: var(--gradient-danger);">
                            <i class="fas fa-credit-card"></i>
                        </div>
                        <div class="stat-card-trend down">
                            <i class="fas fa-arrow-down"></i>
                            <span>5.2%</span>
                        </div>
                    </div>
                    <div class="stat-card-value" id="totalLiabilities">₹0</div>
                    <div class="stat-card-label">Total Liabilities</div>
                </div>

                <div class="stat-card fade-in" style="animation-delay: 0.2s;">
                    <div class="stat-card-header">
                        <div class="stat-card-icon" style="background: var(--gradient-success);">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="stat-card-trend up">
                            <i class="fas fa-arrow-up"></i>
                            <span>18.3%</span>
                        </div>
                    </div>
                    <div class="stat-card-value" id="netWorth">₹0</div>
                    <div class="stat-card-label">Net Worth</div>
                </div>

                <div class="stat-card fade-in" style="animation-delay: 0.3s;">
                    <div class="stat-card-header">
                        <div class="stat-card-icon" style="background: var(--gradient-warm);">
                            <i class="fas fa-bullseye"></i>
                        </div>
                        <div class="stat-card-trend up">
                            <i class="fas fa-arrow-up"></i>
                            <span>8.7%</span>
                        </div>
                    </div>
                    <div class="stat-card-value" id="goalsProgress">0%</div>
                    <div class="stat-card-label">Goals Progress</div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="grid grid-cols-2 mb-4">
                <div class="card fade-in">
                    <div class="card-header">
                        <h3 class="card-title">Asset Distribution</h3>
                    </div>
                    <div style="position: relative; height: 300px;">
                        <canvas id="assetsChart"></canvas>
                    </div>
                </div>

                <div class="card fade-in" style="animation-delay: 0.1s;">
                    <div class="card-header">
                        <h3 class="card-title">Financial Overview</h3>
                    </div>
                    <div style="position: relative; height: 300px;">
                        <canvas id="overviewChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Goals Section -->
            <div class="card fade-in mb-4">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-bullseye"></i> Financial Goals</h3>
                    <div class="card-actions">
                        <button class="card-action-btn" id="addGoalBtn" title="Add Goal">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body" id="goalsContainer">
                    <p style="color: var(--text-tertiary); text-align: center; padding: 2rem;">
                        <i class="fas fa-bullseye" style="font-size: 3rem; margin-bottom: 1rem; display: block; opacity: 0.3;"></i>
                        No financial goals set yet. Add your first goal to start tracking!
                    </p>
                </div>
            </div>

            <!-- Financial Analysis Section -->
            <div class="card fade-in mb-4" id="financialAnalysisCard" style="display: none;">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-chart-line"></i> Financial Analysis & Insights</h3>
                    <div class="card-actions">
                        <button class="card-action-btn" id="insightsInfoBtn" title="About Insights">
                            <i class="fas fa-info-circle"></i>
                        </button>
                        <button class="card-action-btn" onclick="showInsights()" title="View Detailed Insights">
                            <i class="fas fa-lightbulb"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="financialAnalysis"></div>
                </div>
            </div>

            <!-- Update Financial Data Form -->
            <div class="card fade-in">
                <div class="card-header">
                    <h3 class="card-title">Update Financial Data</h3>
                    <div class="card-actions">
                        <button class="card-action-btn" id="financialDataInfoBtn">
                            <i class="fas fa-info-circle"></i>
                        </button>
                    </div>
                </div>
                <form id="financialDataForm">
                    <div class="grid grid-cols-2">
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-piggy-bank"></i> Savings
                            </label>
                            <input type="number" class="form-control" id="savings" placeholder="Enter savings amount" step="0.01" min="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-chart-pie"></i> Mutual Funds
                            </label>
                            <input type="number" class="form-control" id="mutualFunds" placeholder="Enter mutual funds amount" step="0.01" min="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-chart-line"></i> Stocks
                            </label>
                            <input type="number" class="form-control" id="stocks" placeholder="Enter stocks amount" step="0.01" min="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-credit-card"></i> Loan
                            </label>
                            <input type="number" class="form-control" id="loan" placeholder="Enter loan amount" step="0.01" min="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-credit-card"></i> Credit Card Due
                            </label>
                            <input type="number" class="form-control" id="creditCard" placeholder="Enter credit card due" step="0.01" min="0">
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i>
                        Save Financial Data
                    </button>
                </form>
            </div>
            </div>
            <!-- End Dashboard Content -->
            </div>
            <!-- End of Dynamic Content Area -->
        </div>
    </div>

    <!-- Modals and Overlays -->
    <!-- Info Modal -->
    <div id="infoModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 id="infoModalTitle">Information</h3>
                <button class="modal-close" onclick="closeModal('infoModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="infoModalBody">
            </div>
        </div>
    </div>

    <!-- Add Goal Modal -->
    <div id="addGoalModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Add Financial Goal</h3>
                <button class="modal-close" onclick="closeModal('addGoalModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="addGoalForm">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-bullseye"></i> Goal Name
                        </label>
                        <input type="text" class="form-control" id="newGoalName" placeholder="e.g., Buy Car, Emergency Fund" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-rupee-sign"></i> Current Amount (₹)
                        </label>
                        <input type="number" class="form-control" id="newGoalCurrent" placeholder="Enter current amount saved" step="0.01" min="0" value="0">
                        <small style="color: var(--text-tertiary); font-size: 0.875rem; margin-top: 0.25rem; display: block;">
                            How much have you already saved towards this goal?
                        </small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-tag"></i> Target Amount (₹)
                        </label>
                        <input type="number" class="form-control" id="newGoalTarget" placeholder="Enter target amount" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-calendar"></i> Target Year
                        </label>
                        <input type="number" class="form-control" id="newGoalYear" placeholder="2025" min="2025" max="2100" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-tag"></i> Priority (Optional)
                        </label>
                        <select class="form-control" id="newGoalPriority">
                            <option value="high">High</option>
                            <option value="medium" selected>Medium</option>
                            <option value="low">Low</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-folder"></i> Category (Optional)
                        </label>
                        <select class="form-control" id="newGoalCategory">
                            <option value="savings">Savings</option>
                            <option value="emergency">Emergency Fund</option>
                            <option value="vehicle">Vehicle</option>
                            <option value="property">Property</option>
                            <option value="retirement">Retirement</option>
                            <option value="lifestyle">Lifestyle</option>
                            <option value="education">Education</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('addGoalModal')" style="flex: 1;">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-primary" style="flex: 1;">
                            <i class="fas fa-save"></i> Add Goal
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Goal Modal -->
    <div id="editGoalModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3><i class="fas fa-edit" style="margin-right: 0.5rem;"></i>Edit Financial Goal</h3>
                <button class="modal-close" onclick="closeModal('editGoalModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="editGoalForm">
                    <input type="hidden" id="editGoalId">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-bullseye"></i> Goal Name
                        </label>
                        <input type="text" class="form-control" id="editGoalName" placeholder="e.g., Buy Car, Emergency Fund" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-rupee-sign"></i> Current Amount (₹)
                        </label>
                        <input type="number" class="form-control" id="editGoalCurrent" placeholder="Enter current amount saved" step="0.01" min="0" required>
                        <small style="color: var(--text-tertiary); font-size: 0.875rem; margin-top: 0.25rem; display: block;">
                            Update this to track your progress towards the goal
                        </small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-tag"></i> Target Amount (₹)
                        </label>
                        <input type="number" class="form-control" id="editGoalTarget" placeholder="Enter target amount" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-calendar"></i> Target Year
                        </label>
                        <input type="number" class="form-control" id="editGoalYear" placeholder="2025" min="2025" max="2100" required>
                    </div>
                    <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('editGoalModal')" style="flex: 1;">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-primary" style="flex: 1;">
                            <i class="fas fa-save"></i> Update Goal
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Create Graph Modal -->
    <div id="createGraphModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3><i class="fas fa-magic"></i> Create AI-Generated Graph</h3>
                <button class="modal-close" onclick="closeModal('createGraphModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="createGraphForm">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-comment-alt"></i> Describe the graph you want to create
                            <button type="button" class="btn btn-sm btn-secondary" style="margin-left: 0.5rem; padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="enhancePrompt()" title="Let AI enhance your prompt for better results">
                                <i class="fas fa-magic"></i> Enhance Prompt
                            </button>
                        </label>
                        <textarea 
                            class="form-control" 
                            id="graphDescription" 
                            placeholder="e.g., Show me a line chart of my monthly expenses over the last 6 months, or a pie chart of my asset distribution, or a bar chart comparing my savings vs investments..."
                            rows="4"
                            required
                        ></textarea>
                        <small style="color: var(--text-tertiary); font-size: 0.875rem; margin-top: 0.25rem; display: block;">
                            Be as specific as you want! Our AI will analyze your financial data and create the perfect visualization. Click "Enhance Prompt" to let AI improve your description.
                        </small>
                    </div>
                    <div id="graphPreviewContainer" style="display: none; margin-top: 1.5rem;">
                        <div class="card">
                            <div class="card-header">
                                <h4>Preview</h4>
                            </div>
                            <div class="card-body">
                                <div style="position: relative; height: 300px;">
                                    <canvas id="graphPreviewCanvas"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="graphGenerateStatus" style="margin-top: 1rem; display: none;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; color: var(--accent-primary);">
                            <i class="fas fa-spinner fa-spin"></i>
                            <span>Generating your graph with AI...</span>
                        </div>
                    </div>
                    <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('createGraphModal')" style="flex: 1;">
                            Cancel
                        </button>
                        <button type="button" class="btn btn-primary" id="generateGraphBtn" style="flex: 1;" onclick="generateGraphWithAI(event)">
                            <i class="fas fa-magic"></i> Generate Graph
                        </button>
                        <button type="button" class="btn btn-success" id="saveGraphBtn" style="flex: 1; display: none;" onclick="saveCustomGraph()">
                            <i class="fas fa-save"></i> Save Graph
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Goal Confirmation Modal -->
    <div id="deleteGoalModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header" style="border-bottom: 2px solid var(--accent-danger);">
                <h3 style="color: var(--accent-danger);">
                    <i class="fas fa-exclamation-triangle" style="margin-right: 0.5rem;"></i>Delete Goal
                </h3>
                <button class="modal-close" onclick="closeModal('deleteGoalModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" style="padding: 2rem;">
                <div style="text-align: center; margin-bottom: 1.5rem;">
                    <div style="width: 80px; height: 80px; margin: 0 auto 1rem; border-radius: 50%; background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-trash" style="font-size: 2rem; color: var(--accent-danger);"></i>
                    </div>
                    <h3 style="margin: 0 0 0.5rem 0; color: var(--text-primary);">Are you sure?</h3>
                    <p style="color: var(--text-secondary); margin: 0; line-height: 1.6;">
                        You are about to delete the goal <strong id="deleteGoalName" style="color: var(--text-primary);"></strong>.
                        <br>This action cannot be undone.
                    </p>
                </div>
                <div style="background: var(--bg-elevated); padding: 1rem; border-radius: var(--radius-md); margin-bottom: 1.5rem; border-left: 4px solid var(--accent-warning);">
                    <div style="display: flex; align-items: center; gap: 0.5rem; color: var(--text-secondary);">
                        <i class="fas fa-info-circle" style="color: var(--accent-warning);"></i>
                        <span style="font-size: 0.875rem;">All progress and data associated with this goal will be permanently removed.</span>
                    </div>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('deleteGoalModal')" style="flex: 1;">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button type="button" class="btn" onclick="confirmDeleteGoal()" style="flex: 1; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 12px rgba(239, 68, 68, 0.4)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">
                        <i class="fas fa-trash"></i> Delete Goal
                    </button>
                </div>
            </div>
        </div>
    </div>
    <input type="hidden" id="deleteGoalId">

    <!-- Add Transaction Modal -->
    <div id="addTransactionModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Add Transaction</h3>
                <button class="modal-close" onclick="closeModal('addTransactionModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="addTransactionFormModal">
                    <div class="form-group">
                        <label class="form-label">Type</label>
                        <select class="form-control" id="transactionTypeModal" required>
                            <option value="income">Income</option>
                            <option value="expense">Expense</option>
                            <option value="transfer">Transfer</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Category</label>
                        <select class="form-control" id="transactionCategoryModal" required>
                            <option value="food">Food & Dining</option>
                            <option value="shopping">Shopping</option>
                            <option value="bills">Bills & Utilities</option>
                            <option value="transport">Transport</option>
                            <option value="entertainment">Entertainment</option>
                            <option value="salary">Salary</option>
                            <option value="investment">Investment</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Amount (₹)</label>
                        <input type="number" class="form-control" id="transactionAmountModal" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <input type="text" class="form-control" id="transactionDescriptionModal" placeholder="Transaction description" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" class="form-control" id="transactionDateModal" required>
                    </div>
                    <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('addTransactionModal')" style="flex: 1;">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-primary" style="flex: 1;">
                            <i class="fas fa-save"></i> Add Transaction
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Budget Category Modal -->
    <div id="addBudgetCategoryModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Add Budget Category</h3>
                <button class="modal-close" onclick="closeModal('addBudgetCategoryModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="addBudgetCategoryFormModal">
                    <div class="form-group">
                        <label class="form-label">Category Name</label>
                        <input type="text" class="form-control" id="budgetCategoryNameModal" placeholder="e.g., Food, Transport" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Monthly Budget (₹)</label>
                        <input type="number" class="form-control" id="budgetCategoryAmountModal" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Icon</label>
                        <select class="form-control" id="budgetCategoryIconModal">
                            <option value="fa-circle">Default</option>
                            <option value="fa-utensils">Food & Dining</option>
                            <option value="fa-car">Transport</option>
                            <option value="fa-shopping-bag">Shopping</option>
                            <option value="fa-file-invoice-dollar">Bills & Utilities</option>
                            <option value="fa-gamepad">Entertainment</option>
                            <option value="fa-heartbeat">Healthcare</option>
                            <option value="fa-graduation-cap">Education</option>
                            <option value="fa-home">Home</option>
                            <option value="fa-credit-card">Credit Card</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Color</label>
                        <input type="color" class="form-control" id="budgetCategoryColorModal" value="#10b981" style="height: 45px;">
                    </div>
                    <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('addBudgetCategoryModal')" style="flex: 1;">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-primary" style="flex: 1;">
                            <i class="fas fa-save"></i> Save Category
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Investment Modal -->
    <div id="addInvestmentModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3>Add Investment</h3>
                <button class="modal-close" onclick="closeModal('addInvestmentModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="addInvestmentFormModal">
                    <div class="form-group">
                        <label class="form-label">Investment Name</label>
                        <input type="text" class="form-control" id="investmentNameModal" placeholder="e.g., HDFC Equity Fund, Reliance Industries" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Investment Type</label>
                        <select class="form-control" id="investmentTypeModal" required>
                            <option value="mutual_fund">Mutual Fund</option>
                            <option value="stock">Stock</option>
                            <option value="fixed_deposit">Fixed Deposit</option>
                            <option value="gold">Gold</option>
                            <option value="etf">ETF</option>
                            <option value="bond">Bond</option>
                            <option value="savings">Savings Account</option>
                        </select>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                        <div class="form-group">
                            <label class="form-label">Invested Amount (₹)</label>
                            <input type="number" class="form-control" id="investmentAmountModal" step="0.01" min="0" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Current Value (₹)</label>
                            <input type="number" class="form-control" id="investmentCurrentValueModal" step="0.01" min="0" required>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                        <div class="form-group">
                            <label class="form-label">Symbol/Code (Optional)</label>
                            <input type="text" class="form-control" id="investmentSymbolModal" placeholder="e.g., RELIANCE, TCS">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Quantity (Optional)</label>
                            <input type="number" class="form-control" id="investmentQuantityModal" step="1" min="0" placeholder="No. of shares/units">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                        <div class="form-group">
                            <label class="form-label">Risk Level</label>
                            <select class="form-control" id="investmentRiskLevelModal" required>
                                <option value="low">Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Category</label>
                            <select class="form-control" id="investmentCategoryModal" required>
                                <option value="equity">Equity</option>
                                <option value="fixed_income">Fixed Income</option>
                                <option value="commodity">Commodity</option>
                                <option value="hybrid">Hybrid</option>
                            </select>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                        <div class="form-group">
                            <label class="form-label">Purchase Date</label>
                            <input type="date" class="form-control" id="investmentPurchaseDateModal" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Maturity Date (Optional)</label>
                            <input type="date" class="form-control" id="investmentMaturityDateModal">
                        </div>
                    </div>
                    <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('addInvestmentModal')" style="flex: 1;">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-primary" style="flex: 1;">
                            <i class="fas fa-save"></i> Save Investment
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Chart Menu Dropdown -->
    <div id="chartMenu" class="dropdown-menu" style="display: none;">
        <a href="#" onclick="exportChart('assets'); closeDropdown('chartMenu'); return false;">
            <i class="fas fa-download"></i> Export Chart
        </a>
        <a href="#" onclick="refreshChart('assets'); closeDropdown('chartMenu'); return false;">
            <i class="fas fa-sync"></i> Refresh Data
        </a>
        <a href="#" onclick="showChartInfo('assets'); closeDropdown('chartMenu'); return false;">
            <i class="fas fa-info-circle"></i> Chart Info
        </a>
    </div>

    <!-- Notifications Dropdown -->
    <div id="notificationsDropdown" class="dropdown-menu" style="display: none;">
        <div class="dropdown-header">Notifications</div>
        <div id="notificationsList">
            <div class="notification-item">
                <i class="fas fa-chart-line notification-icon"></i>
                <div class="notification-content">
                    <div class="notification-title">Financial Data Updated</div>
                    <div class="notification-time">2 hours ago</div>
                </div>
            </div>
            <div class="notification-item">
                <i class="fas fa-bullseye notification-icon"></i>
                <div class="notification-content">
                    <div class="notification-title">Goal Progress Update</div>
                    <div class="notification-time">1 day ago</div>
                </div>
            </div>
            <div class="notification-item">
                <i class="fas fa-lightbulb notification-icon"></i>
                <div class="notification-content">
                    <div class="notification-title">New Insight Available</div>
                    <div class="notification-time">2 days ago</div>
                </div>
            </div>
        </div>
        <div class="dropdown-footer">
            <a href="#" onclick="markAllNotificationsRead(); return false;">Mark all as read</a>
        </div>
    </div>

    <!-- Messages Dropdown -->
    <div id="messagesDropdown" class="dropdown-menu" style="display: none;">
        <div class="dropdown-header">Messages</div>
        <div id="messagesList">
            <div class="message-item">
                <i class="fas fa-user-circle message-avatar"></i>
                <div class="message-content">
                    <div class="message-title">Welcome to FinGenie!</div>
                    <div class="message-preview">Start by adding your financial data...</div>
                    <div class="message-time">3 days ago</div>
                </div>
            </div>
        </div>
        <div class="dropdown-footer">
            <a href="#" onclick="viewAllMessages(); return false;">View all messages</a>
        </div>
    </div>

    <!-- Loan Calculator Modal -->
    <div id="loanCalculatorModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 900px; width: 90%; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-calculator"></i> Loan Calculator</h3>
                <button class="modal-close" onclick="closeLoanCalculatorModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <!-- Loan Calculator Tabs -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-calculator"></i> Loan Calculators</h3>
                        <div class="card-actions">
                            <div class="btn-group">
                                <button class="btn btn-sm btn-primary loan-tab-btn active" onclick="switchLoanTab('emi')">
                                    <i class="fas fa-calculator"></i> EMI Calculator
                                </button>
                                <button class="btn btn-sm btn-secondary loan-tab-btn" onclick="switchLoanTab('prepayment')">
                                    <i class="fas fa-money-bill-wave"></i> Prepayment
                                </button>
                                <button class="btn btn-sm btn-secondary loan-tab-btn" onclick="switchLoanTab('affordability')">
                                    <i class="fas fa-wallet"></i> Affordability
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- EMI Calculator Tab -->
                        <div id="emiCalculatorTab" class="loan-tab-content active">
                            <form id="loanCalculatorForm" onsubmit="event.preventDefault(); calculateEMI(); return false;">
                                <div class="grid grid-cols-2 gap-4 mb-4">
                                    <div class="form-group">
                                        <label class="form-label">Loan Type</label>
                                        <select id="loanPresetSelect" class="form-control">
                                            <option value="">Select Loan Type</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Loan Amount (₹)</label>
                                        <input type="number" id="loanPrincipal" class="form-control currency-input" 
                                               placeholder="Enter loan amount" step="1000" min="0" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Interest Rate (% per annum)</label>
                                        <input type="number" id="loanRate" class="form-control" 
                                               placeholder="Enter interest rate" step="0.1" min="0" max="30" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Loan Tenure</label>
                                        <div style="display: flex; gap: 1rem; align-items: center;">
                                            <input type="range" id="loanTenureSlider" class="form-control" 
                                                   min="1" max="360" value="60" style="flex: 1;">
                                            <input type="number" id="loanTenure" class="form-control" 
                                                   placeholder="Months" min="1" max="360" value="60" 
                                                   style="width: 100px;" required>
                                        </div>
                                        <div id="tenureDisplay" style="margin-top: 0.5rem; color: var(--text-tertiary); font-size: 0.875rem;">5 years</div>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-calculator"></i> Calculate EMI
                                </button>
                            </form>
                            
                            <!-- EMI Results -->
                            <div id="emiResultsSection" style="display: none; margin-top: 2rem;">
                                <div class="grid grid-cols-4 gap-4 mb-4">
                                    <div class="stat-card">
                                        <div class="stat-card-header">
                                            <div class="stat-card-icon">
                                                <i class="fas fa-money-bill-wave"></i>
                                            </div>
                                        </div>
                                        <div class="stat-card-value" id="emiAmount">₹0</div>
                                        <div class="stat-card-label">Monthly EMI</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-card-header">
                                            <div class="stat-card-icon" style="background: var(--gradient-success);">
                                                <i class="fas fa-rupee-sign"></i>
                                            </div>
                                        </div>
                                        <div class="stat-card-value" id="totalAmount">₹0</div>
                                        <div class="stat-card-label">Total Amount</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-card-header">
                                            <div class="stat-card-icon" style="background: var(--gradient-danger);">
                                                <i class="fas fa-percentage"></i>
                                            </div>
                                        </div>
                                        <div class="stat-card-value" id="totalInterest">₹0</div>
                                        <div class="stat-card-label">Total Interest</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-card-header">
                                            <div class="stat-card-icon" style="background: var(--gradient-warm);">
                                                <i class="fas fa-chart-pie"></i>
                                            </div>
                                        </div>
                                        <div class="stat-card-value" id="interestPercentage">0%</div>
                                        <div class="stat-card-label">Interest %</div>
                                    </div>
                                </div>
                                
                                <!-- Amortization Schedule -->
                                <div class="card">
                                    <div class="card-header">
                                        <h4 class="card-title"><i class="fas fa-table"></i> Amortization Schedule (First 12 Months)</h4>
                                    </div>
                                    <div class="card-body" id="amortizationSchedule">
                                        <!-- Schedule will be populated here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Prepayment Calculator Tab -->
                        <div id="prepaymentCalculatorTab" class="loan-tab-content" style="display: none;">
                            <form id="prepaymentCalculatorForm" onsubmit="calculatePrepaymentSavings(); return false;">
                                <div class="grid grid-cols-2 gap-4 mb-4">
                                    <div class="form-group">
                                        <label class="form-label">Loan Principal (₹)</label>
                                        <input type="number" id="prepayPrincipal" class="form-control" 
                                               placeholder="Enter loan amount" step="1000" min="0" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Interest Rate (% per annum)</label>
                                        <input type="number" id="prepayRate" class="form-control" 
                                               placeholder="Enter interest rate" step="0.1" min="0" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Loan Tenure (Months)</label>
                                        <input type="number" id="prepayTenure" class="form-control" 
                                               placeholder="Enter tenure" min="1" max="360" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Prepayment Amount (₹)</label>
                                        <input type="number" id="prepaymentAmount" class="form-control" 
                                               placeholder="Enter prepayment amount" step="1000" min="0" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Prepayment Month</label>
                                        <input type="number" id="prepaymentMonth" class="form-control" 
                                               placeholder="Month number" min="1" required>
                                        <small style="color: var(--text-tertiary);">Enter the month in which you plan to make the prepayment</small>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-calculator"></i> Calculate Savings
                                </button>
                            </form>
                            
                            <!-- Prepayment Results -->
                            <div id="prepaymentResultsSection" style="display: none; margin-top: 2rem;">
                                <div class="grid grid-cols-3 gap-4">
                                    <div class="stat-card">
                                        <div class="stat-card-header">
                                            <div class="stat-card-icon" style="background: var(--gradient-success);">
                                                <i class="fas fa-rupee-sign"></i>
                                            </div>
                                        </div>
                                        <div class="stat-card-value" id="prepayInterestSaved">₹0</div>
                                        <div class="stat-card-label">Interest Saved</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-card-header">
                                            <div class="stat-card-icon" style="background: var(--gradient-primary);">
                                                <i class="fas fa-percentage"></i>
                                            </div>
                                        </div>
                                        <div class="stat-card-value" id="prepaySavingsPercentage">0%</div>
                                        <div class="stat-card-label">Savings %</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-card-header">
                                            <div class="stat-card-icon" style="background: var(--gradient-warm);">
                                                <i class="fas fa-calendar-alt"></i>
                                            </div>
                                        </div>
                                        <div class="stat-card-value" id="prepayMonthsReduced">0</div>
                                        <div class="stat-card-label">Months Reduced</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Affordability Calculator Tab -->
                        <div id="affordabilityCalculatorTab" class="loan-tab-content" style="display: none;">
                            <form id="affordabilityCalculatorForm" onsubmit="calculateAffordability(); return false;">
                                <div class="grid grid-cols-2 gap-4 mb-4">
                                    <div class="form-group">
                                        <label class="form-label">Monthly Income (₹)</label>
                                        <input type="number" id="affordabilityIncome" class="form-control" 
                                               placeholder="Enter monthly income" step="1000" min="0" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Monthly Expenses (₹)</label>
                                        <input type="number" id="affordabilityExpenses" class="form-control" 
                                               placeholder="Enter monthly expenses" step="1000" min="0" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">EMI to Income Ratio</label>
                                        <input type="number" id="affordabilityRatio" class="form-control" 
                                               placeholder="0.4" step="0.1" min="0.1" max="0.6" value="0.4" required>
                                        <small style="color: var(--text-tertiary);">Recommended: 40% (0.4). Maximum EMI should not exceed this percentage of income.</small>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-calculator"></i> Calculate Affordability
                                </button>
                            </form>
                            
                            <!-- Affordability Results -->
                            <div id="affordabilityResultsSection" style="display: none; margin-top: 2rem;">
                                <div class="card">
                                    <div class="card-body">
                                        <h4 style="margin-bottom: 1rem;"><i class="fas fa-info-circle"></i> Affordability Analysis</h4>
                                        <div class="stat-card" style="margin-bottom: 1rem;">
                                            <div class="stat-card-header">
                                                <div class="stat-card-icon" style="background: var(--gradient-success);">
                                                    <i class="fas fa-rupee-sign"></i>
                                                </div>
                                            </div>
                                            <div class="stat-card-value" id="affordabilityEMI">₹0</div>
                                            <div class="stat-card-label">Maximum Affordable EMI</div>
                                        </div>
                                        <p id="affordabilityRecommendation" style="color: var(--text-secondary); padding: 1rem; background: var(--bg-tertiary); border-radius: var(--radius-md);"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Loan Calculator Button (only visible on Loans page) -->
    <button id="loanCalculatorFloatingBtn" onclick="openLoanCalculatorModal()" 
            style="position: fixed; bottom: 2rem; right: 2rem; width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #00d4ff 0%, #a855f7 100%); border: none; color: white; font-size: 1.5rem; cursor: pointer; box-shadow: 0 8px 24px rgba(0,212,255,0.4), 0 0 40px rgba(168,85,247,0.3); z-index: 9999; display: none; align-items: center; justify-content: center; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);"
            onmouseover="this.style.transform='translateY(-3px) scale(1.1)'; this.style.boxShadow='0 12px 32px rgba(0,212,255,0.5), 0 0 50px rgba(168,85,247,0.4)';"
            onmouseout="this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='0 8px 24px rgba(0,212,255,0.4), 0 0 40px rgba(168,85,247,0.3)';"
            title="Loan Calculator">
        <i class="fas fa-calculator"></i>
    </button>

    <script src="{{ url_for('static', filename='js/theme-toggle.js') }}"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script src="{{ url_for('static', filename='js/dashboard-pages.js') }}"></script>
    <script src="{{ url_for('static', filename='js/pages-functionality.js') }}" onerror="console.error('Failed to load pages-functionality.js')"></script>
    <script src="{{ url_for('static', filename='js/loan-calculator.js') }}"></script>
    <script>
        // Wait for pages-functionality.js to load before proceeding
        function waitForInitializePages(callback, maxAttempts = 50) {
            let attempts = 0;
            const checkInterval = setInterval(() => {
                attempts++;
                if (typeof window.initializePages === 'function') {
                    clearInterval(checkInterval);
                    console.log('✅ initializePages function loaded successfully');
                    callback();
                } else if (attempts >= maxAttempts) {
                    clearInterval(checkInterval);
                    console.error('❌ Failed to load initializePages function after', maxAttempts, 'attempts');
                }
            }, 50);
        }
    </script>
    <script>
        // Define showPage function IMMEDIATELY before any DOM manipulation
        window.showPage = function(page, event) {
            console.log('showPage called with:', page, event ? 'event provided' : 'no event');
            
            const pages = {
                'analytics': { title: 'Analytics & Trends', subtitle: 'Analyze your financial trends and patterns' },
                'budget': { title: 'Budget Planning', subtitle: 'Create and manage your monthly budgets' },
                'investments': { title: 'Investment Portfolio', subtitle: 'Track and manage your investments' },
                'transactions': { title: 'Transaction History', subtitle: 'View all your financial transactions' },
                'goals': { title: 'Financial Goals', subtitle: 'Set and track your financial objectives' },
                'loans': { title: 'Loans & Debt', subtitle: 'View and manage all your loans and debts' },
                'reports': { title: 'Financial Reports', subtitle: 'Generate detailed financial reports' },
                'insights': { title: 'Financial Insights', subtitle: 'AI-powered financial recommendations' },
                'profile': { title: 'User Profile', subtitle: 'Manage your account information' },
                'settings': { title: 'Settings', subtitle: 'Customize your FinGenie experience' },
                'about': { title: 'About FinGenie', subtitle: 'Learn more about your AI-powered finance assistant' },
                'help': { title: 'Help & Support', subtitle: 'Get help and find answers to common questions' },
                'privacy': { title: 'Privacy Policy', subtitle: 'How we protect and handle your data' },
                'terms': { title: 'Terms of Service', subtitle: 'Terms and conditions for using FinGenie' }
            };

            // Sync URL hash without page reload
            if (page && page !== 'dashboard') {
                if (window.location.hash !== '#' + page) {
                    window.location.hash = page;
                }
            } else if (page === 'dashboard') {
                if (window.location.hash) {
                    history.replaceState(null, '', window.location.pathname);
                }
            }

            // Update active menu item
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Find and activate the clicked menu item
            if (event && event.target) {
                const clickedItem = event.target.closest('.menu-item');
                if (clickedItem) {
                    clickedItem.classList.add('active');
                }
            } else {
                // Fallback: find menu item by page name
                document.querySelectorAll('.menu-item').forEach(item => {
                    const onclick = item.getAttribute('onclick') || '';
                    if (onclick.includes(`showPage('${page}')`) || onclick.includes(`showPage("${page}")`) || 
                        onclick.includes(`'${page}'`) || onclick.includes(`"${page}"`)) {
                        item.classList.add('active');
                    }
                });
            }

            const pageData = pages[page];
            console.log('Page data for', page, ':', pageData);
            
            // Show/hide loan calculator floating button based on current page
            const loanCalculatorBtn = document.getElementById('loanCalculatorFloatingBtn');
            if (loanCalculatorBtn) {
                if (page === 'loans') {
                    loanCalculatorBtn.style.display = 'flex';
                } else {
                    loanCalculatorBtn.style.display = 'none';
                }
            }
            
            if (pageData) {
                document.getElementById('pageTitle').textContent = pageData.title;
                document.getElementById('pageSubtitle').textContent = pageData.subtitle;
                loadPageContent(page);
            } else {
                console.error('Page not found in pages dictionary:', page);
                // Show default dashboard
                document.getElementById('pageTitle').textContent = 'Financial Overview';
                document.getElementById('pageSubtitle').textContent = 'Track your financial health and progress';
                loadPageContent('dashboard');
            }
        };
        
        // Sidebar toggle for mobile
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebar = document.getElementById('sidebar');
        
        // Show toggle button on mobile
        if (window.innerWidth <= 1024) {
            sidebarToggle.style.display = 'flex';
        }
        
        sidebarToggle.addEventListener('click', () => {
            sidebar.classList.toggle('active');
        });

        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', (e) => {
            if (window.innerWidth <= 1024) {
                if (!sidebar.contains(e.target) && !sidebarToggle.contains(e.target)) {
                    sidebar.classList.remove('active');
                }
            }
        });

        // Resize handler
        window.addEventListener('resize', () => {
            if (window.innerWidth <= 1024) {
                sidebarToggle.style.display = 'flex';
            } else {
                sidebarToggle.style.display = 'none';
                sidebar.classList.remove('active');
            }
        });

        // Load initial page from URL hash and handle hash changes
        document.addEventListener('DOMContentLoaded', () => {
            const hashPage = (window.location.hash || '').replace('#', '');
            if (hashPage) {
                showPage(hashPage);
            }
            
            // Initialize loan calculator button visibility
            const loanCalculatorBtn = document.getElementById('loanCalculatorFloatingBtn');
            if (loanCalculatorBtn) {
                const currentPage = hashPage || 'dashboard';
                if (currentPage === 'loans') {
                    loanCalculatorBtn.style.display = 'flex';
                } else {
                    loanCalculatorBtn.style.display = 'none';
                }
            }
        });
        window.addEventListener('hashchange', () => {
            const hashPage = (window.location.hash || '').replace('#', '');
            if (hashPage) {
                showPage(hashPage);
            } else {
                showPage('dashboard');
            }
            
            // Update loan calculator button visibility on hash change
            const loanCalculatorBtn = document.getElementById('loanCalculatorFloatingBtn');
            if (loanCalculatorBtn) {
                const currentPage = hashPage || 'dashboard';
                if (currentPage === 'loans') {
                    loanCalculatorBtn.style.display = 'flex';
                } else {
                    loanCalculatorBtn.style.display = 'none';
                }
            }
        });

        // Load page content
        function loadPageContent(page) {
            console.log('loadPageContent called with page:', page);
            const pageContent = document.getElementById('pageContent');
            const dashboardContent = document.querySelector('.dashboard-content');
            
            if (!pageContent) {
                console.error('pageContent element not found!');
                return;
            }
            
            if (page === 'dashboard') {
                console.log('Loading dashboard page');
                if (dashboardContent) {
                    dashboardContent.style.display = 'block';
                }
                // Remove any page sections
                document.querySelectorAll('.page-section').forEach(section => section.remove());
                return;
            }

            console.log('Loading page:', page);
            
            // Hide dashboard, show page-specific content
            if (dashboardContent) {
                dashboardContent.style.display = 'none';
            }
            
            // Remove existing page sections
            document.querySelectorAll('.page-section').forEach(section => section.remove());
            
            // Clear page initialization tracking when switching pages
            if (typeof window.clearPageInitialization === 'function') {
                window.clearPageInitialization();
            }
            
            const content = getPageContent(page);
            console.log('Content retrieved for', page, ':', content ? 'Found' : 'Not found');
            
            if (content) {
                const pageDiv = document.createElement('div');
                pageDiv.className = 'page-section active';
                pageDiv.innerHTML = content;
                pageContent.appendChild(pageDiv);
                console.log('Page content added to DOM for:', page);
                console.log('Page div created with classes:', pageDiv.className);
                console.log('Page div display style:', window.getComputedStyle(pageDiv).display);
                
                // Ensure pageContent container is visible
                pageContent.style.setProperty('display', 'block', 'important');
                pageContent.style.setProperty('visibility', 'visible', 'important');
                
                // Force display on the page div with !important equivalent
                pageDiv.style.setProperty('display', 'block', 'important');
                pageDiv.style.setProperty('visibility', 'visible', 'important');
                pageDiv.style.setProperty('opacity', '1', 'important');
                
                // Verify the element is in DOM and visible
                setTimeout(() => {
                    const addedSection = document.querySelector('.page-section.active');
                    console.log('Page section in DOM:', addedSection !== null);
                    console.log('Page section count:', document.querySelectorAll('.page-section').length);
                    if (addedSection) {
                        const computedStyle = window.getComputedStyle(addedSection);
                        console.log('Page section computed display:', computedStyle.display);
                        console.log('Page section computed visibility:', computedStyle.visibility);
                        console.log('Page section computed opacity:', computedStyle.opacity);
                        console.log('Page section offsetHeight:', addedSection.offsetHeight);
                        console.log('Page section innerHTML length:', addedSection.innerHTML.length);
                        console.log('Page section classes:', addedSection.className);
                        console.log('Page section parent:', addedSection.parentElement);
                    }
                }, 50);
                
                // Initialize page functionality after content is added
                // Wait for initializePages to be available, then call it with retries
                waitForInitializePages(() => {
                    // First attempt after 100ms
                setTimeout(() => {
                        if (typeof window.initializePages === 'function') {
                        console.log('🔄 Calling initializePages for:', page);
                            window.initializePages();
                    }
                }, 100);
                
                    // Retry after 300ms to ensure all elements are rendered
                setTimeout(() => {
                        if (typeof window.initializePages === 'function') {
                        console.log('🔄 Retrying initializePages for:', page);
                            window.initializePages();
                    }
                }, 300);
                
                    // Final retry after 500ms
                setTimeout(() => {
                        if (typeof window.initializePages === 'function') {
                        console.log('🔄 Final retry initializePages for:', page);
                            window.initializePages();
                    }
                    // Also manually trigger load if it's a specific page
                    if (page === 'goals' && typeof loadGoalsPageData === 'function') {
                        console.log('🔄 Manually calling loadGoalsPageData for goals page');
                        loadGoalsPageData();
                    }
                }, 500);
                });
            } else {
                console.error('Page content not found for:', page);
                // If content not found, show error message instead of dashboard
                const errorDiv = document.createElement('div');
                errorDiv.className = 'page-section active';
                errorDiv.innerHTML = `<div class="card"><div class="card-body"><p>Page "${page}" not found.</p></div></div>`;
                pageContent.appendChild(errorDiv);
            }
        }

        // Get page content HTML
        function getPageContent(page) {
            console.log('getPageContent called for:', page);
            const contents = {
                'analytics': `
                    <!-- Stats Summary -->
                    <div class="grid grid-cols-4 mb-4">
                        <div class="stat-card fade-in">
                            <div class="stat-card-header">
                                <div class="stat-card-icon">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                            </div>
                            <div class="stat-card-value" id="analyticsGrowth">0%</div>
                            <div class="stat-card-label">Growth Rate</div>
                        </div>
                        <div class="stat-card fade-in" style="animation-delay: 0.1s;">
                            <div class="stat-card-header">
                                <div class="stat-card-icon" style="background: var(--gradient-success);">
                                    <i class="fas fa-trending-up"></i>
                                </div>
                            </div>
                            <div class="stat-card-value" id="analyticsSavingsRate">0%</div>
                            <div class="stat-card-label">Savings Rate</div>
                        </div>
                        <div class="stat-card fade-in" style="animation-delay: 0.2s;">
                            <div class="stat-card-header">
                                <div class="stat-card-icon" style="background: var(--gradient-danger);">
                                    <i class="fas fa-percentage"></i>
                                </div>
                            </div>
                            <div class="stat-card-value" id="analyticsDebtRatio">0%</div>
                            <div class="stat-card-label">Debt Ratio</div>
                        </div>
                        <div class="stat-card fade-in" style="animation-delay: 0.3s;">
                            <div class="stat-card-header">
                                <div class="stat-card-icon" style="background: var(--gradient-warm);">
                                    <i class="fas fa-chart-bar"></i>
                                </div>
                            </div>
                            <div class="stat-card-value" id="analyticsROI">0%</div>
                            <div class="stat-card-label">ROI Estimate</div>
                        </div>
                    </div>

                    <!-- Charts -->
                    <div class="grid grid-cols-2 mb-4">
                        <div class="card fade-in">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-chart-area"></i> Monthly Trends</h3>
                                <div class="card-actions">
                                    <select class="form-control" style="width: auto; padding: 0.25rem 0.5rem; font-size: 0.875rem;" id="trendPeriod">
                                        <option value="6">Last 6 Months</option>
                                        <option value="12" selected>Last 12 Months</option>
                                        <option value="24">Last 2 Years</option>
                                    </select>
                                </div>
                            </div>
                            <div class="card-body">
                                <div style="position: relative; height: 300px;">
                                    <canvas id="monthlyTrendChart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="card fade-in">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-chart-pie"></i> Asset Category Breakdown</h3>
                            </div>
                            <div class="card-body">
                                <div style="position: relative; height: 300px;">
                                    <canvas id="categoryBreakdownChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Detailed Analysis -->
                    <div class="grid grid-cols-2 mb-4">
                        <div class="card fade-in">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-table"></i> Performance Metrics</h3>
                            </div>
                            <div class="card-body">
                                <div id="performanceMetrics">
                                    <div style="padding: 1rem; border-bottom: 1px solid var(--border-primary);">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                            <span><i class="fas fa-wallet"></i> Asset Growth</span>
                                            <strong id="assetGrowthVal">Calculating...</strong>
                                        </div>
                                    </div>
                                    <div style="padding: 1rem; border-bottom: 1px solid var(--border-primary);">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                            <span><i class="fas fa-chart-line"></i> Investment Performance</span>
                                            <strong id="investmentPerfVal">Calculating...</strong>
                                        </div>
                                    </div>
                                    <div style="padding: 1rem;">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                            <span><i class="fas fa-bullseye"></i> Goal Progress</span>
                                            <strong id="goalProgressVal">Calculating...</strong>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card fade-in">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-calendar-alt"></i> Time Period Analysis</h3>
                            </div>
                            <div class="card-body">
                                <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                                    <button class="btn btn-secondary" onclick="loadAnalyticsPeriod('week')">Week</button>
                                    <button class="btn btn-secondary" onclick="loadAnalyticsPeriod('month')">Month</button>
                                    <button class="btn btn-secondary" onclick="loadAnalyticsPeriod('year')">Year</button>
                                </div>
                                <div id="periodAnalysis">
                                    <p style="color: var(--text-tertiary);">Select a time period to view analysis</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Custom Graphs Section -->
                    <div class="card fade-in mb-4">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-magic"></i> AI-Generated Custom Graphs</h3>
                            <div class="card-actions">
                                <button class="btn btn-primary" onclick="openCreateGraphModal()">
                                    <i class="fas fa-plus"></i> Create New Graph
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="customGraphsContainer" class="grid grid-cols-2" style="gap: 1rem;">
                                <p style="color: var(--text-tertiary); grid-column: 1 / -1; text-align: center; padding: 2rem;">
                                    No custom graphs yet. Click "Create New Graph" to generate your first AI-powered visualization!
                                </p>
                            </div>
                        </div>
                    </div>
                `,
                'budget': `
                    <!-- Monthly Income -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-rupee-sign"></i> Monthly Income</h3>
                        </div>
                        <div class="card-body">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <div style="flex: 1;">
                                    <label class="form-label">Monthly Income (₹)</label>
                                    <input type="number" class="form-control" id="monthlyIncomeInput" step="0.01" min="0" placeholder="Enter monthly income">
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 0.875rem; color: var(--text-tertiary); margin-bottom: 0.25rem;">Current Income</div>
                                    <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent-primary);" id="monthlyIncome">₹0</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Budget Overview -->
                    <div class="grid grid-cols-3 mb-4">
                        <div class="stat-card fade-in">
                            <div class="stat-card-header">
                                <div class="stat-card-icon">
                                    <i class="fas fa-wallet"></i>
                                </div>
                            </div>
                            <div class="stat-card-value" id="totalBudget">₹0</div>
                            <div class="stat-card-label">Total Budget</div>
                        </div>
                        <div class="stat-card fade-in" style="animation-delay: 0.1s;">
                            <div class="stat-card-header">
                                <div class="stat-card-icon" style="background: var(--gradient-success);">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                            </div>
                            <div class="stat-card-value" id="budgetSpent">₹0</div>
                            <div class="stat-card-label">Amount Spent</div>
                        </div>
                        <div class="stat-card fade-in" style="animation-delay: 0.2s;">
                            <div class="stat-card-header">
                                <div class="stat-card-icon" style="background: var(--gradient-warm);">
                                    <i class="fas fa-percentage"></i>
                                </div>
                            </div>
                            <div class="stat-card-value" id="budgetRemaining">0%</div>
                            <div class="stat-card-label">Remaining</div>
                        </div>
                    </div>

                    <!-- Budget Categories -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-list"></i> Budget Categories</h3>
                            <div class="card-actions">
                                <button class="card-action-btn" id="addBudgetCategoryBtn">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="budgetCategoriesList" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                                <p style="color: var(--text-tertiary); text-align: center; padding: 2rem; grid-column: 1 / -1;">
                                    <i class="fas fa-wallet" style="font-size: 3rem; margin-bottom: 1rem; display: block; opacity: 0.3;"></i>
                                    No budget categories set. Create your monthly budget to start tracking!
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Budget Progress Chart -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-chart-bar"></i> Budget vs Spending</h3>
                        </div>
                        <div class="card-body">
                            <div style="position: relative; height: 300px;">
                                <canvas id="budgetChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Add Budget Category Modal (will be added dynamically) -->
                `,
                'investments': `
                    <!-- Investment Summary -->
                    <div class="grid grid-cols-4 mb-4">
                        <div class="stat-card fade-in">
                            <div class="stat-card-header">
                                <div class="stat-card-icon">
                                    <i class="fas fa-chart-pie"></i>
                                </div>
                            </div>
                            <div class="stat-card-value" id="totalInvestments">₹0</div>
                            <div class="stat-card-label">Total Investments</div>
                        </div>
                        <div class="stat-card fade-in" style="animation-delay: 0.1s;">
                            <div class="stat-card-header">
                                <div class="stat-card-icon" style="background: var(--gradient-success);">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                            </div>
                            <div class="stat-card-value" id="investmentReturns">₹0</div>
                            <div class="stat-card-label">Estimated Returns</div>
                        </div>
                        <div class="stat-card fade-in" style="animation-delay: 0.2s;">
                            <div class="stat-card-header">
                                <div class="stat-card-icon" style="background: var(--gradient-primary);">
                                    <i class="fas fa-percentage"></i>
                                </div>
                            </div>
                            <div class="stat-card-value" id="investmentROI">0%</div>
                            <div class="stat-card-label">ROI</div>
                        </div>
                        <div class="stat-card fade-in" style="animation-delay: 0.3s;">
                            <div class="stat-card-header">
                                <div class="stat-card-icon" style="background: var(--gradient-warm);">
                                    <i class="fas fa-coins"></i>
                                </div>
                            </div>
                            <div class="stat-card-value" id="investmentCount">0</div>
                            <div class="stat-card-label">Active Investments</div>
                        </div>
                    </div>

                    <!-- Investment Charts -->
                    <div class="grid grid-cols-2 mb-4">
                        <div class="card fade-in">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-chart-pie"></i> Investment Distribution</h3>
                            </div>
                            <div class="card-body">
                                <div style="position: relative; height: 300px;">
                                    <canvas id="investmentDistributionChart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="card fade-in">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-chart-area"></i> Investment Performance</h3>
                            </div>
                            <div class="card-body">
                                <div style="position: relative; height: 300px;">
                                    <canvas id="investmentPerformanceChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Investment Portfolio List -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-list"></i> Investment Portfolio</h3>
                            <div class="card-actions">
                                <button class="card-action-btn" id="addInvestmentBtn">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="investmentsList" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                                <p style="color: var(--text-tertiary); text-align: center; padding: 2rem; grid-column: 1 / -1;">
                                    <i class="fas fa-chart-pie" style="font-size: 3rem; margin-bottom: 1rem; display: block; opacity: 0.3;"></i>
                                    Loading investments...
                                </p>
                            </div>
                        </div>
                    </div>
                `,
                'transactions': `
                    <!-- Transaction Summary -->
                    <div class="grid grid-cols-4 mb-4">
                        <div class="stat-card fade-in">
                            <div class="stat-card-header">
                                <div class="stat-card-icon" style="background: var(--gradient-success);">
                                    <i class="fas fa-arrow-down"></i>
                                </div>
                            </div>
                            <div class="stat-card-value" id="totalIncome">₹0</div>
                            <div class="stat-card-label">Total Income</div>
                        </div>
                        <div class="stat-card fade-in" style="animation-delay: 0.1s;">
                            <div class="stat-card-header">
                                <div class="stat-card-icon" style="background: var(--gradient-danger);">
                                    <i class="fas fa-arrow-up"></i>
                                </div>
                            </div>
                            <div class="stat-card-value" id="totalExpenses">₹0</div>
                            <div class="stat-card-label">Total Expenses</div>
                        </div>
                        <div class="stat-card fade-in" style="animation-delay: 0.2s;">
                            <div class="stat-card-header">
                                <div class="stat-card-icon" style="background: var(--gradient-primary);">
                                    <i class="fas fa-exchange-alt"></i>
                                </div>
                            </div>
                            <div class="stat-card-value" id="totalTransactions">0</div>
                            <div class="stat-card-label">Transactions</div>
                        </div>
                        <div class="stat-card fade-in" style="animation-delay: 0.3s;">
                            <div class="stat-card-header">
                                <div class="stat-card-icon" style="background: var(--gradient-warm);">
                                    <i class="fas fa-balance-scale"></i>
                                </div>
                            </div>
                            <div class="stat-card-value" id="netTransaction">₹0</div>
                            <div class="stat-card-label">Net Amount</div>
                        </div>
                    </div>

                    <!-- Filters and Add Transaction -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-filter"></i> Filters</h3>
                            <div class="card-actions">
                                <button class="card-action-btn" id="addTransactionBtn">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                                <div class="form-group" style="flex: 1; min-width: 150px;">
                                    <label class="form-label">Type</label>
                                    <select class="form-control" id="transactionTypeFilter">
                                        <option value="all">All Types</option>
                                        <option value="income">Income</option>
                                        <option value="expense">Expense</option>
                                        <option value="transfer">Transfer</option>
                                    </select>
                                </div>
                                <div class="form-group" style="flex: 1; min-width: 150px;">
                                    <label class="form-label">Category</label>
                                    <select class="form-control" id="transactionCategoryFilter">
                                        <option value="all">All Categories</option>
                                        <option value="food">Food & Dining</option>
                                        <option value="shopping">Shopping</option>
                                        <option value="bills">Bills & Utilities</option>
                                        <option value="transport">Transport</option>
                                        <option value="entertainment">Entertainment</option>
                                        <option value="salary">Salary</option>
                                        <option value="investment">Investment</option>
                                    </select>
                                </div>
                                <div class="form-group" style="flex: 1; min-width: 150px;">
                                    <label class="form-label">Date Range</label>
                                    <select class="form-control" id="transactionDateFilter">
                                        <option value="all">All Time</option>
                                        <option value="today">Today</option>
                                        <option value="week">This Week</option>
                                        <option value="month" selected>This Month</option>
                                        <option value="year">This Year</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Transaction List -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-list"></i> Transaction History</h3>
                        </div>
                        <div class="card-body">
                            <div id="transactionsList">
                                <p style="color: var(--text-tertiary); text-align: center; padding: 2rem;">
                                    <i class="fas fa-exchange-alt" style="font-size: 3rem; margin-bottom: 1rem; display: block; opacity: 0.3;"></i>
                                    No transactions found. Add your first transaction to start tracking!
                                </p>
                            </div>
                        </div>
                    </div>
                `,
                'goals': `
                    <!-- Goals Summary -->
                    <div class="grid grid-cols-4 mb-4">
                        <div class="stat-card fade-in">
                            <div class="stat-card-header">
                                <div class="stat-card-icon">
                                    <i class="fas fa-bullseye"></i>
                                </div>
                            </div>
                            <div class="stat-card-value" id="totalGoals">0</div>
                            <div class="stat-card-label">Total Goals</div>
                        </div>
                        <div class="stat-card fade-in" style="animation-delay: 0.1s;">
                            <div class="stat-card-header">
                                <div class="stat-card-icon" style="background: var(--gradient-success);">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                            </div>
                            <div class="stat-card-value" id="completedGoals">0</div>
                            <div class="stat-card-label">Completed</div>
                        </div>
                        <div class="stat-card fade-in" style="animation-delay: 0.2s;">
                            <div class="stat-card-header">
                                <div class="stat-card-icon" style="background: var(--gradient-primary);">
                                    <i class="fas fa-spinner"></i>
                                </div>
                            </div>
                            <div class="stat-card-value" id="activeGoals">0</div>
                            <div class="stat-card-label">Active Goals</div>
                        </div>
                        <div class="stat-card fade-in" style="animation-delay: 0.3s;">
                            <div class="stat-card-header">
                                <div class="stat-card-icon" style="background: var(--gradient-warm);">
                                    <i class="fas fa-percentage"></i>
                                </div>
                            </div>
                            <div class="stat-card-value" id="goalsProgressAvg">0%</div>
                            <div class="stat-card-label">Avg. Progress</div>
                        </div>
                    </div>

                    <!-- Goals List -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-bullseye"></i> Financial Goals</h3>
                            <div class="card-actions">
                                <button class="card-action-btn" onclick="document.getElementById('addGoalModal').style.display = 'flex'">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body" id="goalsPageContainer">
                            <div id="goalsPageList" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                                <p style="color: var(--text-tertiary); text-align: center; padding: 2rem; grid-column: 1 / -1;">
                                    <i class="fas fa-bullseye" style="font-size: 3rem; margin-bottom: 1rem; display: block; opacity: 0.3;"></i>
                                    No financial goals set yet. Add your first goal to start tracking!
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Goals Progress Chart -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-chart-line"></i> Goals Progress</h3>
                        </div>
                        <div class="card-body">
                            <div style="position: relative; height: 300px;">
                                <canvas id="goalsProgressChart"></canvas>
                            </div>
                        </div>
                    </div>
                `,
                'loans': `
                    <!-- Loans Summary -->
                    <div class="grid grid-cols-4 mb-4">
                        <div class="stat-card fade-in">
                            <div class="stat-card-header">
                                <div class="stat-card-icon" style="background: var(--gradient-danger);">
                                    <i class="fas fa-file-invoice-dollar"></i>
                                </div>
                            </div>
                            <div class="stat-card-value" id="totalLoans">₹0</div>
                            <div class="stat-card-label">Total Loans</div>
                        </div>
                        <div class="stat-card fade-in" style="animation-delay: 0.1s;">
                            <div class="stat-card-header">
                                <div class="stat-card-icon" style="background: var(--gradient-warning);">
                                    <i class="fas fa-home"></i>
                                </div>
                            </div>
                            <div class="stat-card-value" id="homeLoanAmount">₹0</div>
                            <div class="stat-card-label">Home Loan</div>
                        </div>
                        <div class="stat-card fade-in" style="animation-delay: 0.2s;">
                            <div class="stat-card-header">
                                <div class="stat-card-icon" style="background: var(--gradient-primary);">
                                    <i class="fas fa-car"></i>
                                </div>
                            </div>
                            <div class="stat-card-value" id="carLoanAmount">₹0</div>
                            <div class="stat-card-label">Car Loan</div>
                        </div>
                        <div class="stat-card fade-in" style="animation-delay: 0.3s;">
                            <div class="stat-card-header">
                                <div class="stat-card-icon" style="background: var(--gradient-info);">
                                    <i class="fas fa-wallet"></i>
                                </div>
                            </div>
                            <div class="stat-card-value" id="personalLoanAmount">₹0</div>
                            <div class="stat-card-label">Personal Loan</div>
                        </div>
                    </div>

                    <!-- All Loans List -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-list"></i> All Loans & Debts</h3>
                        </div>
                        <div class="card-body">
                            <div id="loansList" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                                <p style="color: var(--text-tertiary); text-align: center; padding: 2rem; grid-column: 1 / -1;">
                                    <i class="fas fa-spinner fa-spin"></i> Loading loans...
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Debt Summary -->
                    <div class="grid grid-cols-3 mb-4">
                        <div class="card fade-in">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-credit-card"></i> Credit Card</h3>
                            </div>
                            <div class="card-body">
                                <div class="stat-card-value" id="creditCardDue">₹0</div>
                                <div class="stat-card-label">Outstanding Balance</div>
                            </div>
                        </div>
                        <div class="card fade-in" style="animation-delay: 0.1s;">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-file-invoice"></i> Other Loans</h3>
                            </div>
                            <div class="card-body">
                                <div class="stat-card-value" id="otherLoans">₹0</div>
                                <div class="stat-card-label">Other Loan Amount</div>
                            </div>
                        </div>
                        <div class="card fade-in" style="animation-delay: 0.2s;">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-percentage"></i> Debt Ratio</h3>
                            </div>
                            <div class="card-body">
                                <div class="stat-card-value" id="debtRatioDisplay">0%</div>
                                <div class="stat-card-label">Of Total Assets</div>
                            </div>
                        </div>
                    </div>
                `,
                'reports': `
                    <!-- Report Options -->
                    <div class="grid grid-cols-2 mb-4" style="align-items: start;">
                        <div class="card fade-in">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-calendar"></i> Generate Report</h3>
                            </div>
                            <div class="card-body">
                                <form id="reportForm">
                                    <div class="form-group">
                                        <label class="form-label">Report Type</label>
                                        <select class="form-control" id="reportType" required>
                                            <option value="summary">Financial Summary</option>
                                            <option value="monthly">Monthly Report</option>
                                            <option value="annual">Annual Report</option>
                                            <option value="goals">Goals Progress Report</option>
                                            <option value="investments">Investment Report</option>
                                            <option value="full">Complete Financial Report</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Date Range</label>
                                        <div style="display: flex; gap: 1rem;">
                                            <input type="date" class="form-control" id="reportStartDate" required>
                                            <input type="date" class="form-control" id="reportEndDate" required>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Format</label>
                                        <select class="form-control" id="reportFormat">
                                            <option value="json">JSON</option>
                                            <option value="pdf">PDF</option>
                                        </select>
                                    </div>
                                    <button type="submit" class="btn btn-primary w-100">
                                        <i class="fas fa-file-download"></i> Generate & Download Report
                                    </button>
                                </form>
                            </div>
                        </div>
                        <div class="card fade-in" style="height: 100%; display: flex; flex-direction: column; max-height: 500px;">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-history"></i> Recent Reports</h3>
                            </div>
                            <div class="card-body" style="padding: 0; flex: 1; display: flex; flex-direction: column; overflow: hidden;">
                                <div id="recentReportsList" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; padding: 1.5rem; flex: 1; overflow-y: auto; overflow-x: hidden; min-height: 0;">
                                    <p style="color: var(--text-tertiary); text-align: center; padding: 2rem; grid-column: 1 / -1;">
                                        <i class="fas fa-file-alt" style="font-size: 3rem; margin-bottom: 1rem; display: block; opacity: 0.3;"></i>
                                        No reports generated yet. Create your first report above!
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Export Options -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-bolt"></i> Quick Export</h3>
                        </div>
                        <div class="card-body">
                            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                                <button class="btn btn-primary" onclick="exportData()">
                                    <i class="fas fa-download"></i> Export All Data (JSON)
                                </button>
                                <button class="btn btn-secondary" onclick="exportMonthlyReport()">
                                    <i class="fas fa-calendar-alt"></i> Monthly Summary
                                </button>
                                <button class="btn btn-secondary" onclick="exportGoalsReport()">
                                    <i class="fas fa-bullseye"></i> Goals Report
                                </button>
                                <button class="btn btn-secondary" onclick="exportInvestmentsReport()">
                                    <i class="fas fa-chart-pie"></i> Investments Report
                                </button>
                            </div>
                        </div>
                    </div>
                `,
                'insights': `
                    <!-- Insights Summary -->
                    <div class="grid grid-cols-3 mb-4">
                        <div class="stat-card fade-in">
                            <div class="stat-card-header">
                                <div class="stat-card-icon">
                                    <i class="fas fa-lightbulb"></i>
                                </div>
                            </div>
                            <div class="stat-card-value" id="totalInsights">0</div>
                            <div class="stat-card-label">Active Insights</div>
                        </div>
                        <div class="stat-card fade-in" style="animation-delay: 0.1s;">
                            <div class="stat-card-header">
                                <div class="stat-card-icon" style="background: var(--gradient-warning);">
                                    <i class="fas fa-exclamation-triangle"></i>
                                </div>
                            </div>
                            <div class="stat-card-value" id="warningInsights">0</div>
                            <div class="stat-card-label">Warnings</div>
                        </div>
                        <div class="stat-card fade-in" style="animation-delay: 0.2s;">
                            <div class="stat-card-header">
                                <div class="stat-card-icon" style="background: var(--gradient-success);">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                            </div>
                            <div class="stat-card-value" id="positiveInsights">0</div>
                            <div class="stat-card-label">Positive</div>
                        </div>
                    </div>

                    <!-- Detailed Insights -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-brain"></i> AI-Powered Insights</h3>
                            <div class="card-actions">
                                <button class="card-action-btn" onclick="refreshInsights()">
                                    <i class="fas fa-sync"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body" id="insightsPageContent">
                            <div id="detailedInsights">
                                <p style="color: var(--text-tertiary); text-align: center; padding: 2rem;">
                                    Loading financial insights...
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- All insights are generated by AI above - no separate recommendations section needed -->
                `,
                'profile': `
                    <!-- Profile Header -->
                    <div class="card mb-4">
                        <div class="card-body" style="text-align: center; padding: 3rem;">
                            <div style="width: 120px; height: 120px; border-radius: 50%; background: var(--gradient-primary); display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem; font-size: 3rem; color: white;">
                                <i class="fas fa-user"></i>
                            </div>
                            <h2 style="margin-bottom: 0.5rem;" id="profileDisplayName">User Name</h2>
                            <p style="color: var(--text-tertiary);" id="profileDisplayEmail">user@example.com</p>
                        </div>
                    </div>

                    <!-- Profile Information -->
                    <div class="grid grid-cols-2 mb-4">
                        <div class="card fade-in">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-user-edit"></i> Personal Information</h3>
                            </div>
                            <div class="card-body">
                                <form id="profileForm">
                                    <div class="form-group">
                                        <label class="form-label"><i class="fas fa-user"></i> Full Name</label>
                                        <input type="text" class="form-control" id="profileName" placeholder="Your full name" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label"><i class="fas fa-envelope"></i> Email</label>
                                        <input type="email" class="form-control" id="profileEmail" placeholder="your.email@example.com" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label"><i class="fas fa-phone"></i> Phone Number</label>
                                        <input type="tel" class="form-control" id="profilePhone" placeholder="+91 1234567890">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label"><i class="fas fa-calendar"></i> Date of Birth</label>
                                        <input type="date" class="form-control" id="profileDOB">
                                    </div>
                                    <button type="submit" class="btn btn-primary w-100">
                                        <i class="fas fa-save"></i> Update Profile
                                    </button>
                                </form>
                            </div>
                        </div>
                        <div class="card fade-in">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-shield-alt"></i> Account Security</h3>
                            </div>
                            <div class="card-body">
                                <div style="padding: 1rem; border: 1px solid var(--border-primary); border-radius: var(--radius-md); margin-bottom: 1rem;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <strong>Password</strong>
                                            <p style="margin: 0.25rem 0 0 0; color: var(--text-tertiary); font-size: 0.875rem;">Last updated 30 days ago</p>
                                        </div>
                                        <button class="btn btn-secondary" onclick="showChangePasswordModal()">
                                            <i class="fas fa-key"></i> Change
                                        </button>
                                    </div>
                                </div>
                                <div style="padding: 1rem; border: 1px solid var(--border-primary); border-radius: var(--radius-md);">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <strong>Two-Factor Authentication</strong>
                                            <p style="margin: 0.25rem 0 0 0; color: var(--text-tertiary); font-size: 0.875rem;" id="twoFactorStatus">Add an extra layer of security</p>
                                        </div>
                                        <label style="position: relative; display: inline-block; width: 50px; height: 26px; cursor: pointer;">
                                            <input type="checkbox" id="enable2FA" style="opacity: 0; width: 0; height: 0; position: absolute;">
                                            <span class="toggle-slider" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--bg-tertiary); border-radius: 26px; transition: all 0.3s ease;">
                                                <span class="toggle-knob" style="content: ''; position: absolute; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; border-radius: 50%; transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></span>
                                            </span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Account Statistics -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-chart-bar"></i> Account Statistics</h3>
                        </div>
                        <div class="card-body">
                            <div class="grid grid-cols-4">
                                <div style="text-align: center; padding: 1rem;">
                                    <div style="font-size: 2rem; font-weight: 700; color: var(--accent-primary);" id="accountDaysActive">0</div>
                                    <div style="color: var(--text-tertiary); margin-top: 0.5rem;">Days Active</div>
                                </div>
                                <div style="text-align: center; padding: 1rem;">
                                    <div style="font-size: 2rem; font-weight: 700; color: var(--accent-success);" id="accountDataUpdates">0</div>
                                    <div style="color: var(--text-tertiary); margin-top: 0.5rem;">Data Updates</div>
                                </div>
                                <div style="text-align: center; padding: 1rem;">
                                    <div style="font-size: 2rem; font-weight: 700; color: var(--accent-info);" id="accountGoalsSet">0</div>
                                    <div style="color: var(--text-tertiary); margin-top: 0.5rem;">Goals Set</div>
                                </div>
                                <div style="text-align: center; padding: 1rem;">
                                    <div style="font-size: 2rem; font-weight: 700; color: var(--accent-warning);" id="accountReportsGen">0</div>
                                    <div style="color: var(--text-tertiary); margin-top: 0.5rem;">Reports Generated</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `,
                'settings': `
                    <!-- General Settings -->
                    <div class="grid grid-cols-2 mb-4">
                        <div class="card fade-in">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-globe"></i> General Settings</h3>
                            </div>
                            <div class="card-body">
                                <form id="settingsForm">
                                    <div class="form-group">
                                        <label class="form-label"><i class="fas fa-coins"></i> Currency</label>
                                        <select class="form-control" id="currencySetting">
                                            <option value="INR" selected>₹ Indian Rupee (INR)</option>
                                            <option value="USD">$ US Dollar (USD)</option>
                                            <option value="EUR">€ Euro (EUR)</option>
                                            <option value="GBP">£ British Pound (GBP)</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label"><i class="fas fa-language"></i> Language</label>
                                        <select class="form-control" id="languageSetting">
                                            <option value="en" selected>English</option>
                                            <option value="hi">हिंदी (Hindi)</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label"><i class="fas fa-calendar"></i> Date Format</label>
                                        <select class="form-control" id="dateFormatSetting">
                                            <option value="DD/MM/YYYY" selected>DD/MM/YYYY</option>
                                            <option value="MM/DD/YYYY">MM/DD/YYYY</option>
                                            <option value="YYYY-MM-DD">YYYY-MM-DD</option>
                                        </select>
                                    </div>
                                    <button type="submit" class="btn btn-primary w-100">
                                        <i class="fas fa-save"></i> Save General Settings
                                    </button>
                                </form>
                            </div>
                        </div>
                        <div class="card fade-in">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-bell"></i> Notifications</h3>
                            </div>
                            <div class="card-body">
                                <div style="padding: 1rem; border: 1px solid var(--border-primary); border-radius: var(--radius-md); margin-bottom: 1rem;">
                                    <label style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;">
                                        <div>
                                            <strong><i class="fas fa-envelope"></i> Email Notifications</strong>
                                            <p style="margin: 0.25rem 0 0 0; color: var(--text-tertiary); font-size: 0.875rem;">Receive updates via email</p>
                                        </div>
                                        <input type="checkbox" id="emailNotifications" style="width: 50px; height: 26px;">
                                    </label>
                                </div>
                                <div style="padding: 1rem; border: 1px solid var(--border-primary); border-radius: var(--radius-md); margin-bottom: 1rem;">
                                    <label style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;">
                                        <div>
                                            <strong><i class="fas fa-chart-line"></i> Financial Alerts</strong>
                                            <p style="margin: 0.25rem 0 0 0; color: var(--text-tertiary); font-size: 0.875rem;">Get notified about important changes</p>
                                        </div>
                                        <input type="checkbox" id="financialAlerts" checked style="width: 50px; height: 26px;">
                                    </label>
                                </div>
                                <div style="padding: 1rem; border: 1px solid var(--border-primary); border-radius: var(--radius-md); margin-bottom: 1rem;">
                                    <label style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;">
                                        <div>
                                            <strong><i class="fas fa-bullseye"></i> Goal Reminders</strong>
                                            <p style="margin: 0.25rem 0 0 0; color: var(--text-tertiary); font-size: 0.875rem;">Reminders for your financial goals</p>
                                        </div>
                                        <input type="checkbox" id="goalReminders" checked style="width: 50px; height: 26px;">
                                    </label>
                                </div>
                                <div style="padding: 1rem; border: 1px solid var(--border-primary); border-radius: var(--radius-md);">
                                    <label style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;">
                                        <div>
                                            <strong><i class="fas fa-lightbulb"></i> Insight Updates</strong>
                                            <p style="margin: 0.25rem 0 0 0; color: var(--text-tertiary); font-size: 0.875rem;">New insights and recommendations</p>
                                        </div>
                                        <input type="checkbox" id="insightUpdates" checked style="width: 50px; height: 26px;">
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Privacy & Data -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-shield-alt"></i> Privacy & Data</h3>
                        </div>
                        <div class="card-body">
                            <div style="padding: 1rem; border: 1px solid var(--border-primary); border-radius: var(--radius-md); margin-bottom: 1rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong><i class="fas fa-download"></i> Export My Data</strong>
                                        <p style="margin: 0.25rem 0 0 0; color: var(--text-tertiary); font-size: 0.875rem;">Download all your financial data</p>
                                    </div>
                                    <button class="btn btn-secondary" onclick="exportData()">
                                        <i class="fas fa-file-download"></i> Export
                                    </button>
                                </div>
                            </div>
                            <div style="padding: 1rem; border: 1px solid var(--border-primary); border-radius: var(--radius-md); margin-bottom: 1rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong><i class="fas fa-trash"></i> Delete Account</strong>
                                        <p style="margin: 0.25rem 0 0 0; color: var(--text-tertiary); font-size: 0.875rem;">Permanently delete your account and all data</p>
                                    </div>
                                    <button class="btn btn-danger" onclick="showDeleteAccountModal()">
                                        <i class="fas fa-exclamation-triangle"></i> Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- About -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-info-circle"></i> About FinGenie</h3>
                        </div>
                        <div class="card-body">
                            <p><strong>Version:</strong> 1.0.0</p>
                            <p style="color: var(--text-tertiary); margin-top: 1rem;">
                                FinGenie is your AI-powered personal finance assistant helping you manage your finances,
                                track goals, and make informed financial decisions.
                            </p>
                            <div style="margin-top: 1.5rem; display: flex; gap: 1rem;">
                                <a href="#help" onclick="showPage('help', event); return false;" style="color: var(--accent-primary);"><i class="fas fa-question-circle"></i> Help & Support</a>
                                <a href="#terms" onclick="showPage('terms', event); return false;" style="color: var(--accent-primary);"><i class="fas fa-file-alt"></i> Terms of Service</a>
                                <a href="#privacy" onclick="showPage('privacy', event); return false;" style="color: var(--accent-primary);"><i class="fas fa-lock"></i> Privacy Policy</a>
                            </div>
                        </div>
                    </div>
                `,
                'about': `
                    <!-- About FinGenie -->
                    <div class="card fade-in mb-4">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-info-circle"></i> About FinGenie</h3>
                        </div>
                        <div class="card-body" style="line-height: 1.8;">
                            <div style="text-align: center; margin-bottom: 2rem;">
                                <div style="width: 120px; height: 120px; margin: 0 auto 1.5rem; background: var(--gradient-hero); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 4rem; box-shadow: var(--shadow-glow-cyan);">
                                    <i class="fas fa-coins"></i>
                                </div>
                                <h2 style="font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem;">FinGenie</h2>
                                <p style="color: var(--text-tertiary); font-size: 1.125rem;">Your AI-Powered Personal Finance Assistant</p>
                                <p style="margin-top: 0.5rem;"><strong>Version:</strong> 1.0.0</p>
                            </div>

                            <h4 style="color: var(--accent-cyan); margin: 2rem 0 1rem 0; font-size: 1.25rem;">Mission</h4>
                            <p style="color: var(--text-secondary);">
                                FinGenie is designed to help individuals take control of their financial future through intelligent automation,
                                insightful analytics, and personalized guidance. We believe everyone deserves access to powerful financial tools.
                            </p>

                            <h4 style="color: var(--accent-cyan); margin: 2rem 0 1rem 0; font-size: 1.25rem;">Features</h4>
                            <ul style="color: var(--text-secondary); padding-left: 1.5rem;">
                                <li>AI-powered financial insights and recommendations</li>
                                <li>Real-time budget tracking and expense management</li>
                                <li>Investment portfolio analysis and optimization</li>
                                <li>Goal setting and progress monitoring</li>
                                <li>Comprehensive financial reports and analytics</li>
                                <li>Secure, encrypted data storage</li>
                            </ul>

                            <h4 style="color: var(--accent-cyan); margin: 2rem 0 1rem 0; font-size: 1.25rem;">Technology</h4>
                            <p style="color: var(--text-secondary);">
                                Built with cutting-edge AI technology and modern web frameworks to provide a fast,
                                secure, and intuitive experience across all devices.
                            </p>

                            <div style="margin-top: 2.5rem; padding-top: 2rem; border-top: 1px solid var(--border-primary); display: flex; gap: 1.5rem; flex-wrap: wrap;">
                                <a href="#help" onclick="showPage('help', event); return false;" class="btn btn-primary">
                                    <i class="fas fa-question-circle"></i> Help & Support
                                </a>
                                <a href="#terms" onclick="showPage('terms', event); return false;" class="btn btn-secondary">
                                    <i class="fas fa-file-contract"></i> Terms of Service
                                </a>
                                <a href="#privacy" onclick="showPage('privacy', event); return false;" class="btn btn-secondary">
                                    <i class="fas fa-shield-alt"></i> Privacy Policy
                                </a>
                            </div>
                        </div>
                    </div>
                `,
                'help': `
                    <!-- Help & Support -->
                    <div class="card fade-in mb-4">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-question-circle"></i> Help & Support</h3>
                        </div>
                        <div class="card-body" style="line-height: 1.8;">
                            <h4 style="color: var(--accent-cyan); margin-bottom: 1.5rem; font-size: 1.25rem;">Frequently Asked Questions</h4>

                            <div style="margin-bottom: 2rem; padding: 1.5rem; background: var(--bg-tertiary); border-radius: var(--radius-lg); border: 1px solid var(--border-primary);">
                                <h5 style="color: var(--text-primary); margin-bottom: 0.75rem; font-weight: 600;"><i class="fas fa-chevron-right" style="color: var(--accent-cyan);"></i> How do I get started with FinGenie?</h5>
                                <p style="color: var(--text-secondary); margin-left: 1.5rem;">
                                    Simply enter your financial data in the Dashboard, set your goals, and let our AI analyze your finances.
                                    You'll receive personalized insights and recommendations within minutes.
                                </p>
                            </div>

                            <div style="margin-bottom: 2rem; padding: 1.5rem; background: var(--bg-tertiary); border-radius: var(--radius-lg); border: 1px solid var(--border-primary);">
                                <h5 style="color: var(--text-primary); margin-bottom: 0.75rem; font-weight: 600;"><i class="fas fa-chevron-right" style="color: var(--accent-cyan);"></i> Is my financial data secure?</h5>
                                <p style="color: var(--text-secondary); margin-left: 1.5rem;">
                                    Absolutely. We use bank-level encryption to protect your data. All information is encrypted at rest and in transit.
                                    We never share your data with third parties without your explicit consent.
                                </p>
                            </div>

                            <div style="margin-bottom: 2rem; padding: 1.5rem; background: var(--bg-tertiary); border-radius: var(--radius-lg); border: 1px solid var(--border-primary);">
                                <h5 style="color: var(--text-primary); margin-bottom: 0.75rem; font-weight: 600;"><i class="fas fa-chevron-right" style="color: var(--accent-cyan);"></i> How does the AI Assistant work?</h5>
                                <p style="color: var(--text-secondary); margin-left: 1.5rem;">
                                    Our AI Assistant analyzes your financial data, spending patterns, and goals to provide personalized advice.
                                    You can ask questions about budgeting, investments, or any financial topic, and receive intelligent recommendations.
                                </p>
                            </div>

                            <div style="margin-bottom: 2rem; padding: 1.5rem; background: var(--bg-tertiary); border-radius: var(--radius-lg); border: 1px solid var(--border-primary);">
                                <h5 style="color: var(--text-primary); margin-bottom: 0.75rem; font-weight: 600;"><i class="fas fa-chevron-right" style="color: var(--accent-cyan);"></i> Can I export my data?</h5>
                                <p style="color: var(--text-secondary); margin-left: 1.5rem;">
                                    Yes! You can export all your financial data at any time from the Settings page.
                                    Your data is always yours, and you have full control over it.
                                </p>
                            </div>

                            <h4 style="color: var(--accent-cyan); margin: 2.5rem 0 1.5rem 0; font-size: 1.25rem;">Contact Support</h4>
                            <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                                Can't find what you're looking for? Our support team is here to help!
                            </p>

                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-top: 1.5rem;">
                                <div style="padding: 1.5rem; background: var(--bg-tertiary); border-radius: var(--radius-lg); border: 1px solid var(--border-primary); text-align: center;">
                                    <div style="font-size: 2.5rem; color: var(--accent-cyan); margin-bottom: 1rem;">
                                        <i class="fas fa-envelope"></i>
                                    </div>
                                    <h5 style="margin-bottom: 0.5rem;">Email Support</h5>
                                    <p style="color: var(--text-tertiary); font-size: 0.875rem; margin-bottom: 1rem;">We'll respond within 24 hours</p>
                                    <a href="mailto:support@fingenie.com" style="color: var(--accent-cyan);">support@fingenie.com</a>
                                </div>

                                <div style="padding: 1.5rem; background: var(--bg-tertiary); border-radius: var(--radius-lg); border: 1px solid var(--border-primary); text-align: center;">
                                    <div style="font-size: 2.5rem; color: var(--accent-cyan); margin-bottom: 1rem;">
                                        <i class="fas fa-comments"></i>
                                    </div>
                                    <h5 style="margin-bottom: 0.5rem;">AI Assistant</h5>
                                    <p style="color: var(--text-tertiary); font-size: 0.875rem; margin-bottom: 1rem;">Get instant help 24/7</p>
                                    <a href="/chat" class="btn btn-primary" style="display: inline-flex; align-items: center; gap: 0.5rem;">
                                        <i class="fas fa-robot"></i> Chat Now
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                `,
                'privacy': `
                    <!-- Privacy Policy -->
                    <div class="card fade-in mb-4">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-shield-alt"></i> Privacy Policy</h3>
                        </div>
                        <div class="card-body" style="line-height: 1.8;">
                            <p style="color: var(--text-tertiary); margin-bottom: 2rem; font-style: italic;">
                                Last updated: January 2025
                            </p>

                            <h4 style="color: var(--accent-cyan); margin: 2rem 0 1rem 0; font-size: 1.25rem;">Introduction</h4>
                            <p style="color: var(--text-secondary);">
                                FinGenie ("we", "us", or "our") is committed to protecting your privacy. This Privacy Policy explains how we collect,
                                use, disclose, and safeguard your information when you use our application.
                            </p>

                            <h4 style="color: var(--accent-cyan); margin: 2rem 0 1rem 0; font-size: 1.25rem;">Information We Collect</h4>
                            <p style="color: var(--text-secondary); margin-bottom: 1rem;">We collect information that you provide directly to us:</p>
                            <ul style="color: var(--text-secondary); padding-left: 1.5rem; margin-bottom: 1.5rem;">
                                <li><strong>Account Information:</strong> Name, email address, and password</li>
                                <li><strong>Financial Data:</strong> Income, expenses, assets, liabilities, and goals you choose to enter</li>
                                <li><strong>Usage Data:</strong> How you interact with our services</li>
                                <li><strong>Device Information:</strong> Browser type, IP address, and device identifiers</li>
                            </ul>

                            <h4 style="color: var(--accent-cyan); margin: 2rem 0 1rem 0; font-size: 1.25rem;">How We Use Your Information</h4>
                            <ul style="color: var(--text-secondary); padding-left: 1.5rem; margin-bottom: 1.5rem;">
                                <li>Provide, maintain, and improve our services</li>
                                <li>Personalize your experience and provide tailored recommendations</li>
                                <li>Send you technical notices and support messages</li>
                                <li>Respond to your comments and questions</li>
                                <li>Monitor and analyze trends and usage</li>
                                <li>Detect and prevent fraud and abuse</li>
                            </ul>

                            <h4 style="color: var(--accent-cyan); margin: 2rem 0 1rem 0; font-size: 1.25rem;">Data Security</h4>
                            <p style="color: var(--text-secondary);">
                                We implement industry-standard security measures to protect your personal information:
                            </p>
                            <ul style="color: var(--text-secondary); padding-left: 1.5rem; margin-bottom: 1.5rem;">
                                <li><strong>Encryption:</strong> All data is encrypted in transit (TLS/SSL) and at rest (AES-256)</li>
                                <li><strong>Access Controls:</strong> Strict internal access policies and authentication requirements</li>
                                <li><strong>Regular Audits:</strong> Security assessments and vulnerability testing</li>
                                <li><strong>Secure Infrastructure:</strong> Hosted on secure, monitored servers</li>
                            </ul>

                            <h4 style="color: var(--accent-cyan); margin: 2rem 0 1rem 0; font-size: 1.25rem;">Data Sharing</h4>
                            <p style="color: var(--text-secondary);">
                                We do not sell, trade, or rent your personal information to third parties. We may share information only in these limited circumstances:
                            </p>
                            <ul style="color: var(--text-secondary); padding-left: 1.5rem; margin-bottom: 1.5rem;">
                                <li>With your explicit consent</li>
                                <li>To comply with legal obligations</li>
                                <li>To protect our rights, privacy, safety, or property</li>
                                <li>With service providers who assist in our operations (under strict confidentiality agreements)</li>
                            </ul>

                            <h4 style="color: var(--accent-cyan); margin: 2rem 0 1rem 0; font-size: 1.25rem;">Your Rights</h4>
                            <p style="color: var(--text-secondary); margin-bottom: 1rem;">You have the right to:</p>
                            <ul style="color: var(--text-secondary); padding-left: 1.5rem; margin-bottom: 1.5rem;">
                                <li>Access and receive a copy of your personal data</li>
                                <li>Correct inaccurate or incomplete data</li>
                                <li>Delete your account and associated data</li>
                                <li>Object to or restrict certain processing</li>
                                <li>Export your data in a portable format</li>
                            </ul>

                            <h4 style="color: var(--accent-cyan); margin: 2rem 0 1rem 0; font-size: 1.25rem;">Contact Us</h4>
                            <p style="color: var(--text-secondary);">
                                If you have questions about this Privacy Policy, please contact us at:
                                <a href="mailto:privacy@fingenie.com" style="color: var(--accent-cyan); margin-left: 0.5rem;">privacy@fingenie.com</a>
                            </p>
                        </div>
                    </div>
                `,
                'terms': `
                    <!-- Terms of Service -->
                    <div class="card fade-in mb-4">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-file-contract"></i> Terms of Service</h3>
                        </div>
                        <div class="card-body" style="line-height: 1.8;">
                            <p style="color: var(--text-tertiary); margin-bottom: 2rem; font-style: italic;">
                                Last updated: January 2025
                            </p>

                            <h4 style="color: var(--accent-cyan); margin: 2rem 0 1rem 0; font-size: 1.25rem;">Acceptance of Terms</h4>
                            <p style="color: var(--text-secondary);">
                                By accessing or using FinGenie, you agree to be bound by these Terms of Service. If you do not agree to these terms,
                                please do not use our service.
                            </p>

                            <h4 style="color: var(--accent-cyan); margin: 2rem 0 1rem 0; font-size: 1.25rem;">Description of Service</h4>
                            <p style="color: var(--text-secondary);">
                                FinGenie provides AI-powered personal finance management tools, including budget tracking, investment analysis,
                                goal setting, and financial insights. Our service is designed to help you make informed financial decisions.
                            </p>

                            <h4 style="color: var(--accent-cyan); margin: 2rem 0 1rem 0; font-size: 1.25rem;">User Responsibilities</h4>
                            <p style="color: var(--text-secondary); margin-bottom: 1rem;">You agree to:</p>
                            <ul style="color: var(--text-secondary); padding-left: 1.5rem; margin-bottom: 1.5rem;">
                                <li>Provide accurate and complete information</li>
                                <li>Maintain the security of your account credentials</li>
                                <li>Use the service only for lawful purposes</li>
                                <li>Not attempt to gain unauthorized access to our systems</li>
                                <li>Not use the service to transmit harmful code or content</li>
                                <li>Respect the intellectual property rights of FinGenie and others</li>
                            </ul>

                            <h4 style="color: var(--accent-cyan); margin: 2rem 0 1rem 0; font-size: 1.25rem;">Disclaimer of Warranties</h4>
                            <div style="padding: 1.5rem; background: var(--bg-tertiary); border-radius: var(--radius-lg); border-left: 4px solid var(--warning); margin: 1.5rem 0;">
                                <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                                    <strong>IMPORTANT:</strong> FinGenie is a financial management tool, not a professional financial advisor.
                                    The insights and recommendations provided are for informational purposes only.
                                </p>
                                <ul style="color: var(--text-secondary); padding-left: 1.5rem;">
                                    <li>Our AI provides suggestions based on patterns and data analysis</li>
                                    <li>We do not provide personalized financial, investment, or legal advice</li>
                                    <li>You should consult with qualified professionals for specific financial decisions</li>
                                    <li>Past performance does not guarantee future results</li>
                                </ul>
                            </div>

                            <h4 style="color: var(--accent-cyan); margin: 2rem 0 1rem 0; font-size: 1.25rem;">Limitation of Liability</h4>
                            <p style="color: var(--text-secondary);">
                                To the fullest extent permitted by law, FinGenie shall not be liable for any indirect, incidental, special,
                                consequential, or punitive damages resulting from your use of or inability to use the service.
                            </p>

                            <h4 style="color: var(--accent-cyan); margin: 2rem 0 1rem 0; font-size: 1.25rem;">Account Termination</h4>
                            <p style="color: var(--text-secondary);">
                                You may terminate your account at any time through the Settings page. We reserve the right to suspend or
                                terminate accounts that violate these terms.
                            </p>

                            <h4 style="color: var(--accent-cyan); margin: 2rem 0 1rem 0; font-size: 1.25rem;">Changes to Terms</h4>
                            <p style="color: var(--text-secondary);">
                                We may update these Terms of Service from time to time. We will notify you of any material changes by posting
                                the new terms and updating the "Last updated" date.
                            </p>

                            <h4 style="color: var(--accent-cyan); margin: 2rem 0 1rem 0; font-size: 1.25rem;">Governing Law</h4>
                            <p style="color: var(--text-secondary);">
                                These terms shall be governed by and construed in accordance with applicable laws, without regard to
                                conflict of law provisions.
                            </p>

                            <h4 style="color: var(--accent-cyan); margin: 2rem 0 1rem 0; font-size: 1.25rem;">Contact Information</h4>
                            <p style="color: var(--text-secondary);">
                                For questions about these Terms of Service, contact us at:
                                <a href="mailto:legal@fingenie.com" style="color: var(--accent-cyan); margin-left: 0.5rem;">legal@fingenie.com</a>
                            </p>

                            <div style="margin-top: 2.5rem; padding: 1.5rem; background: var(--bg-tertiary); border-radius: var(--radius-lg); border: 1px solid var(--border-primary); text-align: center;">
                                <p style="color: var(--text-secondary);">
                                    By continuing to use FinGenie, you acknowledge that you have read, understood, and agree to be bound by these Terms of Service.
                                </p>
                            </div>
                        </div>
                    </div>
                `
            };
            const content = contents[page];
            console.log('Available pages:', Object.keys(contents));
            console.log('Requested page:', page);
            console.log('Content found:', content ? 'Yes' : 'No');
            if (!content) {
                console.error('Page content missing for:', page);
                console.log('All available page keys:', Object.keys(contents).join(', '));
            }
            return content || null;
        }
        
        // Make loadPageContent and getPageContent available globally for debugging
        window.loadPageContent = loadPageContent;
        window.getPageContent = getPageContent;

        // Edit Goal Function
        window.editGoal = function(goalId) {
            console.log('Editing goal:', goalId);
            if (typeof getFinancialData === 'function') {
                getFinancialData().then(data => {
                    const goals = data.goals || [];
                    const goal = goals.find(g => g.id === goalId);
                    
                    if (!goal) {
                        alert('Goal not found');
                        return;
                    }
                    
                    // Populate edit form
                    document.getElementById('editGoalId').value = goal.id;
                    document.getElementById('editGoalName').value = goal.name || '';
                    document.getElementById('editGoalCurrent').value = (goal.current || goal.current_amount || 0);
                    document.getElementById('editGoalTarget').value = goal.target || 0;
                    document.getElementById('editGoalYear').value = goal.year || new Date().getFullYear() + 1;
                    
                    // Show modal
                    document.getElementById('editGoalModal').style.display = 'flex';
                }).catch(error => {
                    console.error('Error loading goal:', error);
                    alert('Failed to load goal details');
                });
            } else {
                alert('Financial data service not available');
            }
        };
        
        // Open Delete Goal Modal
        window.openDeleteGoalModal = function(goalId, goalName) {
            console.log('Opening delete modal for goal:', goalId, goalName);
            document.getElementById('deleteGoalId').value = goalId;
            document.getElementById('deleteGoalName').textContent = goalName || 'this goal';
            document.getElementById('deleteGoalModal').style.display = 'flex';
        };
        
        // Confirm Delete Goal
        window.confirmDeleteGoal = async function() {
            const goalId = parseInt(document.getElementById('deleteGoalId').value);
            console.log('Deleting goal:', goalId);
            
            try {
                // Get current financial data
                if (typeof getFinancialData !== 'function') {
                    alert('Financial data service not available');
                    return;
                }
                
                const data = await getFinancialData(true); // Force refresh
                const goals = data.goals || [];
                
                // Remove the goal
                const filteredGoals = goals.filter(g => g.id !== goalId);
                
                if (filteredGoals.length === goals.length) {
                    alert('Goal not found');
                    closeModal('deleteGoalModal');
                    return;
                }
                
                // Save to backend
                const response = await apiRequest('/finance/add_data', 'POST', {
                    goals: filteredGoals
                });
                
                if (response && !response.error) {
                    // Clear cache and reload
                    if (typeof clearFinancialDataCache === 'function') {
                        clearFinancialDataCache();
                    }
                    
                    closeModal('deleteGoalModal');
                    
                    // Reload goals page data
                    if (typeof loadGoalsPageData === 'function') {
                        await loadGoalsPageData();
                    }
                    
                    // Show success message
                    const toast = document.createElement('div');
                    toast.style.cssText = 'position: fixed; top: 20px; right: 20px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 1rem 1.5rem; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 10000; animation: slideInRight 0.3s ease;';
                    toast.innerHTML = '<i class="fas fa-check-circle" style="margin-right: 0.5rem;"></i> Goal deleted successfully!';
                    document.body.appendChild(toast);
                    setTimeout(() => {
                        toast.style.animation = 'slideOutRight 0.3s ease';
                        setTimeout(() => toast.remove(), 300);
                    }, 3000);
                } else {
                    throw new Error(response?.error || 'Failed to delete goal');
                }
            } catch (error) {
                console.error('Error deleting goal:', error);
                alert('Failed to delete goal: ' + error.message);
            }
        };

        let goalInputCount = 1;
        window.addGoalInput = function() {
            const container = document.getElementById('goalsInputContainer');
            const newGoalInput = document.createElement('div');
            newGoalInput.className = 'flex gap-2 mb-2';
            newGoalInput.innerHTML = `
                <input type="text" class="form-control" placeholder="Goal name" id="goalName${goalInputCount}">
                <input type="number" class="form-control" placeholder="Target amount" id="goalTarget${goalInputCount}" step="0.01" min="0">
                <input type="number" class="form-control" placeholder="Year" id="goalYear${goalInputCount}" min="2025" max="2100">
                <button type="button" class="btn btn-danger" onclick="this.parentElement.remove()">
                    <i class="fas fa-trash"></i>
                </button>
            `;
            container.appendChild(newGoalInput);
            goalInputCount++;
        };

        // Add search functionality
        document.querySelector('.topbar-search-input')?.addEventListener('input', function(e) {
            const query = e.target.value.toLowerCase().trim();
            if (query.length > 2) {
                performSearch(query);
            }
        });

        // Financial data form info button
        document.getElementById('financialDataInfoBtn')?.addEventListener('click', function() {
            showInfoModal(
                'Financial Data Entry Guide',
                '<p>Enter your financial information below:</p>' +
                '<ul style="margin-top: 1rem; padding-left: 1.5rem; line-height: 1.8;">' +
                '<li><strong>Assets:</strong> Your savings, mutual funds, and stock investments</li>' +
                '<li><strong>Liabilities:</strong> Any loans or credit card debt</li>' +
                '</ul>' +
                '<p style="margin-top: 1rem; color: var(--text-tertiary);">All amounts should be in ₹ (Indian Rupees).</p>' +
                '<p style="margin-top: 0.5rem; color: var(--text-tertiary);"><strong>Note:</strong> To add financial goals, use the + button in the Financial Goals card above.</p>'
            );
        });

        // Insights info button
        document.getElementById('insightsInfoBtn')?.addEventListener('click', function() {
            showInfoModal(
                'How Financial Insights Are Generated',
                '<p>Our financial insights are generated using advanced analysis algorithms that examine your financial data:</p>' +
                '<ul style="margin-top: 1rem; padding-left: 1.5rem; line-height: 1.8;">' +
                '<li><strong>Asset Allocation Analysis:</strong> Evaluates the distribution of your assets across savings, mutual funds, and stocks to recommend optimal balance</li>' +
                '<li><strong>Debt Ratio Analysis:</strong> Calculates your debt-to-asset ratio and provides recommendations for debt management</li>' +
                '<li><strong>Net Worth Trends:</strong> Analyzes your net worth and projects potential growth based on current financial patterns</li>' +
                '<li><strong>Goal Progress Tracking:</strong> Assesses progress toward your financial goals and suggests monthly savings targets</li>' +
                '</ul>' +
                '<p style="margin-top: 1rem; color: var(--text-tertiary);">Insights are automatically updated whenever you update your financial data. For personalized AI-powered recommendations, visit the AI Assistant.</p>'
            );
        });

        // Add Goal button - opens modal form
        document.getElementById('addGoalBtn')?.addEventListener('click', function() {
            document.getElementById('addGoalModal').style.display = 'flex';
        });

        // Handle add goal form submission
        // Edit Goal Form Handler
        document.getElementById('editGoalForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const goalId = parseInt(document.getElementById('editGoalId').value);
            const goalName = document.getElementById('editGoalName').value.trim();
            const goalCurrent = parseFloat(document.getElementById('editGoalCurrent').value) || 0;
            const goalTarget = parseFloat(document.getElementById('editGoalTarget').value);
            const goalYear = parseInt(document.getElementById('editGoalYear').value);
            
            if (!goalName || !goalTarget || !goalYear) {
                alert('Please fill all required fields');
                return;
            }
            
            try {
                // Get current financial data
                const data = await getFinancialData(true); // Force refresh
                const goals = data.goals || [];
                
                // Find and update the goal
                const goalIndex = goals.findIndex(g => g.id === goalId);
                if (goalIndex === -1) {
                    alert('Goal not found');
                    return;
                }
                
                // Update goal
                goals[goalIndex] = {
                    ...goals[goalIndex],
                    name: goalName,
                    current: goalCurrent,
                    current_amount: goalCurrent,
                    target: goalTarget,
                    year: goalYear
                };
                
                // Save to backend
                const response = await apiRequest('/finance/add_data', 'POST', {
                    goals: goals
                });
                
                if (response && !response.error) {
                    // Clear cache and reload
                    if (typeof clearFinancialDataCache === 'function') {
                        clearFinancialDataCache();
                    }
                    
                    closeModal('editGoalModal');
                    
                    // Reload goals page data
                    if (typeof loadGoalsPageData === 'function') {
                        await loadGoalsPageData();
                    }
                    
                    // Show success message
                    const toast = document.createElement('div');
                    toast.style.cssText = 'position: fixed; top: 20px; right: 20px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 1rem 1.5rem; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 10000; animation: slideInRight 0.3s ease;';
                    toast.innerHTML = '<i class="fas fa-check-circle" style="margin-right: 0.5rem;"></i> Goal updated successfully!';
                    document.body.appendChild(toast);
                    setTimeout(() => {
                        toast.style.animation = 'slideOutRight 0.3s ease';
                        setTimeout(() => toast.remove(), 300);
                    }, 3000);
                } else {
                    throw new Error(response?.error || 'Failed to update goal');
                }
            } catch (error) {
                console.error('Error updating goal:', error);
                alert('Failed to update goal: ' + error.message);
            }
        });

        document.getElementById('addGoalForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const name = document.getElementById('newGoalName').value.trim();
            const current = parseFloat(document.getElementById('newGoalCurrent').value) || 0;
            const target = parseFloat(document.getElementById('newGoalTarget').value);
            const year = parseInt(document.getElementById('newGoalYear').value);
            const priority = document.getElementById('newGoalPriority').value || 'medium';
            const category = document.getElementById('newGoalCategory').value || 'other';

                if (!name || !target || !year) {
                toast.error('Please fill in all required fields (Name, Target Amount, and Year)');
                return;
            }

            if (target <= 0) {
                toast.error('Target amount must be greater than 0');
                return;
            }

            if (year < new Date().getFullYear()) {
                toast.error('Target year must be in the future');
                return;
            }

            try {
                // Get current financial data
                const result = await apiRequest('/finance/get_data');
                const data = result.data || {};
                const currentGoals = data.goals || [];
                
                // Generate unique ID for new goal (find max ID and add 1)
                let maxId = 0;
                if (currentGoals.length > 0) {
                    maxId = Math.max(...currentGoals.map(g => g.id || 0));
                }
                const newGoalId = maxId + 1;
                
                // Create new goal object with all fields
                const newGoal = {
                    id: newGoalId,
                    name: name,
                    target: target,
                    current: current,
                    current_amount: current,
                    year: year,
                    priority: priority,
                    category: category
                };
                
                // Add new goal to existing goals
                const updatedGoals = [...currentGoals, newGoal];
                
                console.log('📝 Adding new goal:', newGoal);
                console.log('📊 Total goals after adding:', updatedGoals.length);

                // Save to backend - backend will validate and only save if we have 5+ goals
                const response = await apiRequest('/finance/add_data', 'POST', {
                    goals: updatedGoals
                });

                if (response && !response.error) {
                    // Clear cache and reload
                    if (typeof clearFinancialDataCache === 'function') {
                        clearFinancialDataCache();
                    }
                    
                    toast.success('Goal added successfully!', 3000);
                    closeModal('addGoalModal');
                    
                    // Reset form
                    document.getElementById('addGoalForm').reset();
                    document.getElementById('newGoalCurrent').value = '0'; // Reset current amount
                    
                    // Reload goals page data if we're on goals page
                    if (typeof loadGoalsPageData === 'function') {
                        await loadGoalsPageData();
                    }
                    
                    // Also reload main dashboard data
                    if (typeof window.loadFinancialData === 'function') {
                        await window.loadFinancialData();
                    }
                } else {
                    throw new Error(response?.error || 'Failed to save goal');
                }
            } catch (error) {
                console.error('Error adding goal:', error);
                toast.error(error.message || 'Failed to add goal. Please try again.');
            }
        });

        // Financial data form submission handler (preserves existing goals)
        document.getElementById('financialDataForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Get existing goals to preserve them
            let goals = [];
            try {
                const currentDataResult = await apiRequest('/finance/get_data');
                const currentData = currentDataResult.data || {};
                goals = currentData.goals || [];
            } catch (error) {
                console.warn('Could not load existing goals:', error);
            }

            const assets = {
                savings: parseFloat(document.getElementById('savings').value) || 0,
                mutual_funds: parseFloat(document.getElementById('mutualFunds').value) || 0,
                stocks: parseFloat(document.getElementById('stocks').value) || 0
            };

            const liabilities = {
                loan: parseFloat(document.getElementById('loan').value) || 0,
                credit_card_due: parseFloat(document.getElementById('creditCard').value) || 0
            };

            try {
                await apiRequest('/finance/add_data', 'POST', { assets, liabilities, goals });
                toast.success('Financial data updated successfully!');
                // Reload data using main.js function
                if (typeof window.loadFinancialData === 'function') {
                    await window.loadFinancialData();
                }
                this.reset();
            } catch (error) {
                toast.error(error.message || 'Failed to update financial data');
            }
        });

        // Logout handler - using apiRequest from main.js
        document.getElementById('logoutBtn').addEventListener('click', async function() {
            try {
                await apiRequest('/auth/logout', 'POST');
                localStorage.removeItem('token');
                window.location.href = '/login';
            } catch (error) {
                console.error('Error:', error);
                localStorage.removeItem('token');
                window.location.href = '/login';
            }
        });
        
        // Loan Calculator Tab Switching
        window.switchLoanTab = function(tab, evt) {
            const event = evt || window.event;
            // Hide all tabs
            document.querySelectorAll('.loan-tab-content').forEach(content => {
                content.style.display = 'none';
            });
            document.querySelectorAll('.loan-tab-btn').forEach(btn => {
                btn.classList.remove('active', 'btn-primary');
                btn.classList.add('btn-secondary');
            });
            
            // Show selected tab
            const tabContent = document.getElementById(tab + 'CalculatorTab');
            const tabBtn = (event && event.target && event.target.closest('.loan-tab-btn')) || 
                          document.querySelector(`.loan-tab-btn[onclick*="${tab}"]`);
            
            if (tabContent) {
                tabContent.style.display = 'block';
                tabContent.classList.add('active');
            }
            
            if (tabBtn) {
                tabBtn.classList.remove('btn-secondary');
                tabBtn.classList.add('active', 'btn-primary');
            }
        };
        
        // Ensure showPage is available immediately when DOM loads
        // Loan Calculator Modal Functions
        window.openLoanCalculatorModal = function() {
            const modal = document.getElementById('loanCalculatorModal');
            if (modal) {
                modal.style.display = 'flex';
                // Load loan presets when modal opens
                if (typeof loadLoanPresets === 'function') {
                    loadLoanPresets();
                }
                // Initialize loan calculator handlers
                if (typeof setupLoanCalculatorHandlers === 'function') {
                    setupLoanCalculatorHandlers();
                }
            }
        };

        window.closeLoanCalculatorModal = function() {
            const modal = document.getElementById('loanCalculatorModal');
            if (modal) {
                modal.style.display = 'none';
            }
        };

        // Close modal when clicking outside
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('loanCalculatorModal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeLoanCalculatorModal();
                    }
                });
            }
        });
    </script>
</body>
</html>
