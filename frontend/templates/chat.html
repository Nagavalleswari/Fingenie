<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Assistant - FinGenie </title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/chat.css') }}">
</head>
<body data-chat-inline="true">
    <!-- Sidebar Navigation -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <a href="/" class="sidebar-logo">
                <div class="sidebar-logo-icon">
                    <i class="fas fa-coins"></i>
                </div>
                <span class="sidebar-logo-text">FinGenie</span>
            </a>
        </div>

        <div class="sidebar-menu">
            <div class="menu-section">
                <div class="menu-section-title">Main</div>
                <a href="/dashboard" class="menu-item">
                    <div class="menu-item-icon"><i class="fas fa-chart-line"></i></div>
                    <span class="menu-item-text">Dashboard</span>
                </a>
                <a href="/chat" class="menu-item active">
                    <div class="menu-item-icon"><i class="fas fa-comments"></i></div>
                    <span class="menu-item-text">AI Assistant</span>
                    <span class="menu-item-badge">New</span>
                </a>
                <a href="/dashboard" class="menu-item" onclick="event.preventDefault(); window.location.href='/dashboard';">
                    <div class="menu-item-icon"><i class="fas fa-chart-bar"></i></div>
                    <span class="menu-item-text">Analytics</span>
                </a>
            </div>

            <div class="menu-section">
                <div class="menu-section-title">Finance</div>
                <a href="/dashboard" class="menu-item" onclick="event.preventDefault(); window.location.href='/dashboard';">
                    <div class="menu-item-icon"><i class="fas fa-wallet"></i></div>
                    <span class="menu-item-text">Budget</span>
                </a>
                <a href="/dashboard" class="menu-item" onclick="event.preventDefault(); window.location.href='/dashboard';">
                    <div class="menu-item-icon"><i class="fas fa-chart-pie"></i></div>
                    <span class="menu-item-text">Investments</span>
                </a>
                <a href="/dashboard" class="menu-item" onclick="event.preventDefault(); window.location.href='/dashboard';">
                    <div class="menu-item-icon"><i class="fas fa-exchange-alt"></i></div>
                    <span class="menu-item-text">Transactions</span>
                </a>
                <a href="/dashboard" class="menu-item" onclick="event.preventDefault(); window.location.href='/dashboard';">
                    <div class="menu-item-icon"><i class="fas fa-bullseye"></i></div>
                    <span class="menu-item-text">Goals</span>
                </a>
                <a href="/dashboard" class="menu-item" onclick="event.preventDefault(); window.location.href='/dashboard';">
                    <div class="menu-item-icon"><i class="fas fa-calculator"></i></div>
                    <span class="menu-item-text">Loan Calculator</span>
                </a>
            </div>

            <div class="menu-section">
                <div class="menu-section-title">Reports</div>
                <a href="/dashboard" class="menu-item" onclick="event.preventDefault(); window.location.href='/dashboard';">
                    <div class="menu-item-icon"><i class="fas fa-file-alt"></i></div>
                    <span class="menu-item-text">Reports</span>
                </a>
                <a href="/dashboard" class="menu-item" onclick="event.preventDefault(); window.location.href='/dashboard';">
                    <div class="menu-item-icon"><i class="fas fa-lightbulb"></i></div>
                    <span class="menu-item-text">Insights</span>
                </a>
            </div>

            <div class="menu-section">
                <div class="menu-section-title">Account</div>
                <a href="/dashboard" class="menu-item" onclick="event.preventDefault(); window.location.href='/dashboard';">
                    <div class="menu-item-icon"><i class="fas fa-user"></i></div>
                    <span class="menu-item-text">Profile</span>
                </a>
                <a href="/dashboard" class="menu-item" onclick="event.preventDefault(); window.location.href='/dashboard';">
                    <div class="menu-item-icon"><i class="fas fa-cog"></i></div>
                    <span class="menu-item-text">Settings</span>
                </a>
            </div>
        </div>

        <div class="sidebar-footer">
            <div class="sidebar-user">
                <div class="sidebar-user-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="sidebar-user-info">
                    <div class="sidebar-user-name">User</div>
                    <div class="sidebar-user-email">user@fingenie.com</div>
                </div>
                <i class="fas fa-sign-out-alt" id="logoutBtn" style="cursor: pointer; color: var(--text-tertiary);"></i>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Top Bar -->
        <div class="topbar">
            <div class="topbar-left">
                <button class="topbar-action-btn" id="sidebarToggle" style="display: none;">
                    <i class="fas fa-bars"></i>
                </button>
                <h1 class="topbar-title">AI Assistant</h1>
            </div>
            <div class="topbar-right">
                <div class="topbar-actions">
                    <!-- Theme Toggle -->
                    <div class="theme-toggle" title="Toggle theme">
                        <i class="fas fa-moon theme-toggle-icon moon"></i>
                        <div class="theme-toggle-slider">
                            <i class="fas fa-moon theme-icon"></i>
                        </div>
                        <i class="fas fa-sun theme-toggle-icon sun"></i>
                    </div>
                    <button class="topbar-action-btn" id="chatHistoryToggleMobile" onclick="toggleChatHistory()" title="Toggle Chat History">
                        <i class="fas fa-history"></i>
                    </button>
                    <button class="topbar-action-btn" onclick="clearChat()" title="Clear Chat">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Content Container -->
        <div class="content-container" style="padding: 0;">
            <div class="chat-wrapper">
                <!-- Chat Sidebar - Conversation History -->
                <div class="chat-sidebar">
                    <div class="chat-sidebar-header">
                        <button class="new-chat-btn1" onclick="startNewChat()">
                            <i class="fas fa-plus"></i>
                            New Chat
                        </button>

                        <!-- Search -->
                        <div style="margin-top: 0.75rem; position: relative;">
                            <input id="chatSearch" type="text" placeholder="Search conversations" oninput="onChatSearch(this.value)"
                                   style="width: 100%; padding: 0.75rem 2.5rem 0.75rem 1rem; border-radius: 12px; border: 1px solid var(--border-primary); background: var(--bg-tertiary); color: var(--text-primary);">
                            <i class="fas fa-search" style="position:absolute; right: 0.75rem; top:50%; transform: translateY(-50%); color: var(--text-tertiary);"></i>
                        </div>

                        <!-- Actions Row -->
                        

                        <!-- Bulk Actions Row (visible in selection mode) -->
                        <div id="bulkActionsRow" style="display:none; margin-top:0.5rem;">
                            <button class="new-chat-btn" onclick="selectAllChats()" style="background: var(--bg-tertiary); border: 1px solid var(--border-primary);">
                                <i class="fas fa-tasks"></i> Select All
                            </button>
                            <button class="new-chat-btn" onclick="deleteSelectedChats()" style="margin-left:0.5rem; background: #3b1a1a; border: 1px solid var(--error);">
                                <i class="fas fa-trash"></i> Delete Selected
                            </button>
                            <button class="new-chat-btn" onclick="exportChats('json','selected')" style="margin-left:0.5rem; background: var(--bg-tertiary); border: 1px solid var(--border-primary);">
                                <i class="fas fa-file-export"></i> Export Selected JSON
                            </button>
                            <button class="new-chat-btn" onclick="exportChats('md','selected')" style="margin-left:0.5rem; background: var(--bg-tertiary); border: 1px solid var(--border-primary);">
                                <i class="fas fa-file-alt"></i> Export Selected MD
                            </button>
                        </div>

                        <button class="new-chat-btn" onclick="clearAllChatHistory()" style="margin-top: 0.75rem; background: var(--bg-tertiary); border: 1px solid var(--border-primary);">
                            <i class="fas fa-trash"></i>
                            Clear History
                        </button>
                        <div style="margin-top:0.5rem; color: var(--text-tertiary); font-size: 0.75rem;">Tip: Double-click a chat to rename. Click the star to pin.</div>
                    </div>
                    <div class="chat-history" id="chatHistory">
                        <p style="color: var(--text-tertiary); text-align: center; padding: 2rem; font-size: 0.875rem;">
                            <i class="fas fa-history" style="font-size: 2rem; display: block; margin-bottom: 0.5rem; opacity: 0.3;"></i>
                            Loading chat history...
                        </p>
                    </div>
                </div>

                <!-- Main Chat Container -->
                <div class="chat-container fade-in">
                    <!-- No duplicate header - using topbar only -->

                    <!-- Loading bar -->
                    <div class="chat-loading" id="chatLoadingBar"></div>
                    <!-- Chat Messages -->
                    <div class="chat-messages" id="chatMessages">
                        <div class="welcome-card">
                        <div class="welcome-icon">
                            <i class="fas fa-robot"></i>
                        </div>
                        <h2 class="welcome-title">Welcome to FinGenie AI</h2>
                        <p class="welcome-text">
                            Your intelligent financial assistant powered by AI. Ask me anything about budgeting, 
                            investments, savings, or financial planning!
                        </p>
                    </div>
                </div>

                    <!-- Chat Input -->
                    <div class="chat-input-area">
                        <div class="chat-input-container">
                            <!-- Quick Suggestions -->
                            <div class="chat-input-suggestions">
                                <div class="suggestion-chip" onclick="sendQuickMessage('Analyze my spending')">
                                    <i class="fas fa-chart-pie"></i> Analyze spending
                                </div>
                                <div class="suggestion-chip" onclick="sendQuickMessage('Investment tips')">
                                    <i class="fas fa-lightbulb"></i> Investment tips
                                </div>
                                <div class="suggestion-chip" onclick="sendQuickMessage('Budget optimization')">
                                    <i class="fas fa-wallet"></i> Budget help
                                </div>
                                <div class="suggestion-chip" onclick="sendQuickMessage('Savings strategies')">
                                    <i class="fas fa-piggy-bank"></i> Save more
                                </div>
                            </div>

                            <form id="chatForm">
                                <div class="chat-input-wrapper">
                                    <textarea 
                                        class="chat-input" 
                                        id="messageInput" 
                                        placeholder="Message FinGenie..." 
                                        required
                                        rows="1"
                                    ></textarea>
                                    <button type="submit" class="chat-send-btn" id="sendBtn">
                                        <i class="fas fa-arrow-up"></i>
                                    </button>
                                    <button type="button" class="chat-stop-btn" id="stopBtn" title="Stop generating" style="display: none;">
                                        <i class="fas fa-stop"></i>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/theme-toggle.js') }}"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script>
        // Sidebar toggle for mobile - FIXED
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebar = document.getElementById('sidebar');
        
        // Show toggle button on mobile
        function updateSidebarToggleVisibility() {
            if (window.innerWidth <= 1024) {
                if (sidebarToggle) {
                    sidebarToggle.style.display = 'flex';
                }
                if (sidebar) {
                    sidebar.classList.remove('active');
                }
            } else {
                if (sidebarToggle) {
                    sidebarToggle.style.display = 'none';
                }
                if (sidebar) {
                    sidebar.classList.remove('active');
                }
            }
        }
        
        // Initialize
        updateSidebarToggleVisibility();
        
        // Add click handler for toggle button
        if (sidebarToggle && sidebar) {
            sidebarToggle.addEventListener('click', function(e) {
                e.stopPropagation();
                sidebar.classList.toggle('active');
            });
        }

        document.addEventListener('click', (e) => {
            if (window.innerWidth <= 1024) {
                if (!sidebar.contains(e.target) && !sidebarToggle.contains(e.target)) {
                    sidebar.classList.remove('active');
                }
            }
        });

        window.addEventListener('resize', () => {
            updateSidebarToggleVisibility();
        });

        function showPage(page) {
            // Navigate to dashboard pages
            if (page !== 'dashboard' && page !== 'chat') {
                window.location.href = `/dashboard#${page}`;
            } else if (page === 'dashboard') {
                window.location.href = '/dashboard';
            }
        }

        // Toggle chat history sidebar
        function toggleChatHistory() {
            const chatSidebar = document.querySelector('.chat-sidebar');
            if (chatSidebar) {
                chatSidebar.classList.toggle('active');
                // Update button icon
                const buttons = document.querySelectorAll('#chatHistoryToggle, #chatHistoryToggleMobile');
                buttons.forEach(btn => {
                    if (btn) {
                        const icon = btn.querySelector('i');
                        if (chatSidebar.classList.contains('active')) {
                            icon.className = 'fas fa-times';
                            btn.title = 'Hide Chat History';
                        } else {
                            icon.className = 'fas fa-history';
                            btn.title = 'Show Chat History';
                        }
                    }
                });
            }
        }

        // Auto-resize textarea and update send button
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 200) + 'px';
            
            // Update send button style based on input
            if (this.value.trim()) {
                sendBtn.classList.add('has-text');
            } else {
                sendBtn.classList.remove('has-text');
            }
        });

        // Press Enter to send (Shift+Enter for new line)
        messageInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                const form = document.getElementById('chatForm');
                if (form) {
                    form.dispatchEvent(new Event('submit', { cancelable: true, bubbles: true }));
                }
            }
        });

        function sendQuickMessage(message) {
            // Hide suggestions immediately
            const suggestionsDiv = document.querySelector('.chat-input-suggestions');
            if (suggestionsDiv) {
                suggestionsDiv.style.display = 'none';
            }
            
            document.getElementById('messageInput').value = message;
            document.getElementById('chatForm').dispatchEvent(new Event('submit', { cancelable: true, bubbles: true }));
        }

        // Chat History Management
        let currentChatId = null;
        let chatMessagesData = [];
        let chatSearchQuery = '';
        let selectionMode = false;
        let selectedChatIds = new Set();

        function initializeChatHistory() {
            loadChatHistory();
            
            // Create new chat if none exists
            if (!currentChatId) {
                startNewChat();
            } else {
                loadChatById(currentChatId);
            }
        }

        function onChatSearch(q) {
            chatSearchQuery = (q || '').trim().toLowerCase();
            loadChatHistory();
        }

        function loadChatHistory() {
            let history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
            const historyContainer = document.getElementById('chatHistory');
            
            // Filter by search
            if (chatSearchQuery) {
                history = history.filter(chat => {
                    const titleMatch = (chat.title || '').toLowerCase().includes(chatSearchQuery);
                    const messagesText = (chat.messages || []).map(m => (m.text || '')).join(' ').toLowerCase();
                    return titleMatch || messagesText.includes(chatSearchQuery);
                });
            }

            // Sort: pinned first, then updatedAt desc, then timestamp desc
            history.sort((a, b) => {
                const pinA = a.pinned ? 1 : 0;
                const pinB = b.pinned ? 1 : 0;
                if (pinA !== pinB) return pinB - pinA;
                const ua = a.updatedAt || a.timestamp || 0;
                const ub = b.updatedAt || b.timestamp || 0;
                return ub - ua;
            });
            
            if (historyContainer) {
                if (history.length === 0) {
                    historyContainer.innerHTML = `
                        <p style="color: var(--text-tertiary); text-align: center; padding: 2rem; font-size: 0.875rem;">
                            <i class="fas fa-history" style="font-size: 2rem; display: block; margin-bottom: 0.5rem; opacity: 0.3;"></i>
                            No chat history ${chatSearchQuery ? 'matching your search' : 'yet'}
                        </p>
                    `;
                } else {
                    let html = '';
                    history.forEach(chat => {
                        const date = new Date(chat.timestamp);
                        const isToday = date.toDateString() === new Date().toDateString();
                        const isYesterday = date.toDateString() === new Date(Date.now() - 86400000).toDateString();
                        
                        let timeStr = '';
                        if (isToday) {
                            timeStr = `Today, ${date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}`;
                        } else if (isYesterday) {
                            timeStr = 'Yesterday';
                        } else {
                            timeStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: date.getFullYear() !== new Date().getFullYear() ? 'numeric' : undefined });
                        }
                        const isActive = chat.id === currentChatId;
                        const isPinned = !!chat.pinned;
                        const isSelected = selectedChatIds.has(chat.id);
                        
                        html += `
                            <div class="chat-history-item ${isActive ? 'active' : ''}" onclick="loadChatById('${chat.id}')" ondblclick="renameChat('${chat.id}')">
                                <div style="display:flex; align-items:center; gap:0.5rem;">
                                    ${selectionMode ? `<input type=\"checkbox\" ${isSelected ? 'checked' : ''} onclick=\"event.stopPropagation(); toggleSelectChat('${chat.id}', this.checked)\" />` : ''}
                                    <i class="${isPinned ? 'fas' : 'far'} fa-star" title="${isPinned ? 'Unpin' : 'Pin'}" onclick="event.stopPropagation(); togglePinned('${chat.id}')" style="color:${isPinned ? 'var(--accent-cyan)' : 'var(--text-tertiary)'};"></i>
                                    <div class="chat-history-title" title="Double-click to rename">${escapeHtml(chat.title || 'New Conversation')}</div>
                                </div>
                                <div class="chat-history-time">${timeStr}</div>
                                <button class="chat-history-delete" onclick="event.stopPropagation(); deleteChat('${chat.id}', event)" title="Delete chat">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        `;
                    });
                    historyContainer.innerHTML = html;
                }
            }

            // Toggle bulk actions row
            const bulkRow = document.getElementById('bulkActionsRow');
            const selectBtn = document.getElementById('selectModeBtn');
            if (bulkRow && selectBtn) {
                bulkRow.style.display = selectionMode ? 'block' : 'none';
                selectBtn.innerHTML = selectionMode ? '<i class="fas fa-times-circle"></i> Exit Select' : '<i class="fas fa-check-square"></i> Select';
            }
        }

        function startNewChat() {
            // Save current chat if it exists
            if (currentChatId && chatMessagesData.length > 0) {
                saveCurrentChat();
            }
            
            // Create new chat
            currentChatId = 'chat_' + Date.now();
            chatMessagesData = [];
            
            // Clear message display
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = `
                <div class="welcome-card">
                    <div class="welcome-icon">
                        <i class="fas fa-robot"></i>
                    </div>
                    <h2 class="welcome-title">Welcome to FinGenie AI</h2>
                    <p class="welcome-text">
                        Your intelligent financial assistant powered by AI. Ask me anything about budgeting, 
                        investments, savings, or financial planning!
                    </p>
                </div>
            `;
            
            // Update history display
            loadChatHistory();
toast.success('New conversation started!', 2000);
        }

        function saveCurrentChat() {
            if (!currentChatId || chatMessagesData.length === 0) return;
            
            // Get chat title from first user message
            const firstUserMessage = chatMessagesData.find(m => m.isUser);
            const fallbackTitle = firstUserMessage ? firstUserMessage.text.substring(0, 50) + (firstUserMessage.text.length > 50 ? '...' : '') : 'New Conversation';
            
            // Get or create history
            let history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
            
            // Find existing chat or create new
            const existingIndex = history.findIndex(chat => chat.id === currentChatId);
            const existing = existingIndex >= 0 ? history[existingIndex] : {};
            const chatData = {
                id: currentChatId,
                title: existing.customTitle || fallbackTitle,
                customTitle: existing.customTitle || null,
                pinned: !!existing.pinned,
                messages: chatMessagesData,
                timestamp: existingIndex >= 0 ? existing.timestamp : Date.now(),
                updatedAt: Date.now()
            };
            
            if (existingIndex >= 0) {
                history[existingIndex] = chatData;
            } else {
                history.unshift(chatData); // Add to beginning
            }
            
            // Keep only last 50 chats
            if (history.length > 50) {
                history = history.slice(0, 50);
            }
            
            localStorage.setItem('chatHistory', JSON.stringify(history));
            loadChatHistory();
        }

        function loadChatById(chatId) {
            const history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
            const chat = history.find(c => c.id === chatId);
            
            if (!chat) {
toast.error('Chat not found');
                return;
            }
            
            currentChatId = chatId;
            chatMessagesData = chat.messages || [];

            // Reset selection when switching chats
            selectedChatIds.clear();
            selectionMode = false;
            
            // Display messages
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            
            if (chatMessagesData.length === 0) {
                chatMessages.innerHTML = `
                    <div class="welcome-card">
                        <div class="welcome-icon">
                            <i class="fas fa-robot"></i>
                        </div>
                        <h2 class="welcome-title">${chat.title}</h2>
                        <p class="welcome-text">This conversation is empty.</p>
                    </div>
                `;
            } else {
                chatMessagesData.forEach(msg => {
                    addMessageToDOM(msg.sender, msg.text, msg.isUser, false);
                });
                
                // Scroll to bottom
                setTimeout(() => {
                    chatMessages.scrollTo({
                        top: chatMessages.scrollHeight,
                        behavior: 'smooth'
                    });
                }, 100);
            }
            
            // Update active state in history
            loadChatHistory();
            
            // Close history sidebar on mobile
            if (window.innerWidth <= 1024) {
                const chatSidebar = document.querySelector('.chat-sidebar');
                if (chatSidebar) {
                    chatSidebar.classList.remove('active');
                }
            }
        }

        function clearChat() {
            // Save current chat before clearing
            if (currentChatId && chatMessagesData.length > 0) {
                saveCurrentChat();
            }
            
            // Clear current chat
            chatMessagesData = [];
            
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = `
                <div class="welcome-card">
                    <div class="welcome-icon">
                        <i class="fas fa-robot"></i>
                    </div>
                    <h2 class="welcome-title">Chat Cleared</h2>
                    <p class="welcome-text">How can I help you with your finances today?</p>
                </div>
            `;
toast.success('Chat cleared successfully');
        }

        function deleteChat(chatId, event) {
            if (event) {
                event.stopPropagation();
            }
            
            const history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
            const filtered = history.filter(chat => chat.id !== chatId);
            
            localStorage.setItem('chatHistory', JSON.stringify(filtered));
            
            // If deleted chat was current, start new one
            if (chatId === currentChatId) {
                startNewChat();
            } else {
                loadChatHistory();
            }
            
toast.success('Chat deleted');
        }

        function togglePinned(chatId) {
            let history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
            const idx = history.findIndex(c => c.id === chatId);
            if (idx >= 0) {
                history[idx].pinned = !history[idx].pinned;
                localStorage.setItem('chatHistory', JSON.stringify(history));
                loadChatHistory();
            }
        }

        function renameChat(chatId) {
            let history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
            const idx = history.findIndex(c => c.id === chatId);
            if (idx < 0) return;
            const currentTitle = history[idx].customTitle || history[idx].title || 'New Conversation';
            const newTitle = prompt('Rename conversation:', currentTitle);
            if (newTitle && newTitle.trim()) {
                history[idx].customTitle = newTitle.trim();
                history[idx].title = newTitle.trim();
                history[idx].updatedAt = Date.now();
                localStorage.setItem('chatHistory', JSON.stringify(history));
                loadChatHistory();
            }
        }

        function toggleSelectionMode() {
            selectionMode = !selectionMode;
            if (!selectionMode) {
                selectedChatIds.clear();
            }
            loadChatHistory();
        }

        function toggleSelectChat(chatId, checked) {
            if (checked) {
                selectedChatIds.add(chatId);
            } else {
                selectedChatIds.delete(chatId);
            }
        }

        function selectAllChats() {
            const history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
            const filtered = chatSearchQuery ? history.filter(c => (c.title||'').toLowerCase().includes(chatSearchQuery) || (c.messages||[]).some(m => (m.text||'').toLowerCase().includes(chatSearchQuery))) : history;
            filtered.forEach(c => selectedChatIds.add(c.id));
            loadChatHistory();
        }

        function deleteSelectedChats() {
            if (selectedChatIds.size === 0) {
toast.info('No conversations selected');
                return;
            }
            if (!confirm(`Delete ${selectedChatIds.size} selected conversation(s)?`)) return;
            let history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
            history = history.filter(c => !selectedChatIds.has(c.id));
            localStorage.setItem('chatHistory', JSON.stringify(history));
            selectedChatIds.clear();
            selectionMode = false;
            loadChatHistory();
toast.success('Selected conversations deleted');
        }

        function exportChats(format = 'json', scope = (selectedChatIds.size > 0 ? 'selected' : (chatSearchQuery ? 'filtered' : 'all'))) {
            const history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
            let chats = [];
            if (scope === 'selected' && selectedChatIds.size > 0) {
                chats = history.filter(c => selectedChatIds.has(c.id));
            } else if (scope === 'filtered' && chatSearchQuery) {
                chats = history.filter(c => (c.title||'').toLowerCase().includes(chatSearchQuery) || (c.messages||[]).some(m => (m.text||'').toLowerCase().includes(chatSearchQuery)));
            } else if (scope === 'current' && currentChatId) {
                const c = history.find(c => c.id === currentChatId);
                if (c) chats = [c];
            } else {
                chats = history;
            }
            if (chats.length === 0) {
toast.info('Nothing to export');
                return;
            }
            const filenameBase = scope === 'current' && chats[0] ? (chats[0].title || 'conversation') : 'conversations';
            if (format === 'json') {
                const json = JSON.stringify(chats, null, 2);
                downloadFile(json, `${filenameBase.replace(/\s+/g,'-').toLowerCase()}-${new Date().toISOString().split('T')[0]}.json`, 'application/json');
            } else {
                const md = chats.map(c => chatToMarkdown(c)).join('\n\n---\n\n');
                downloadFile(md, `${filenameBase.replace(/\s+/g,'-').toLowerCase()}-${new Date().toISOString().split('T')[0]}.md`, 'text/markdown');
            }
toast.success('Export ready');
        }

        function chatToMarkdown(chat) {
            const title = chat.title || 'Conversation';
            const date = new Date(chat.timestamp || Date.now()).toLocaleString();
            let md = `# ${title}\n\n- Date: ${date}${chat.pinned ? ' (pinned)' : ''}\n- Messages: ${(chat.messages||[]).length}\n`;
            (chat.messages || []).forEach(m => {
                const who = m.isUser ? 'You' : (m.sender || 'Assistant');
                md += `\n\n## ${who}\n\n${m.text}\n`;
            });
            return md;
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function formatTimestamp() {
            const now = new Date();
            return now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        }

        // Enhanced Markdown to HTML converter with better formatting
        function markdownToHtml(text) {
            if (!text) return '';
            
            // First escape HTML
            let html = text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
            
            // Headers
            html = html.replace(/^### (.*$)/gim, '<h3 style="font-size: 1.1rem; font-weight: 600; color: var(--text-primary); margin: 1rem 0 0.5rem 0; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border-primary);">$1</h3>');
            html = html.replace(/^## (.*$)/gim, '<h2 style="font-size: 1.25rem; font-weight: 700; color: var(--text-primary); margin: 1.25rem 0 0.75rem 0; padding-bottom: 0.5rem; border-bottom: 2px solid var(--border-primary);">$1</h2>');
            html = html.replace(/^# (.*$)/gim, '<h1 style="font-size: 1.5rem; font-weight: 700; color: var(--text-primary); margin: 1.5rem 0 1rem 0;">$1</h1>');
            
            // Bold and italic
            html = html.replace(/\*\*(.+?)\*\*/g, '<strong style="font-weight: 600; color: var(--text-primary);">$1</strong>');
            html = html.replace(/\*(.+?)\*/g, '<em style="font-style: italic;">$1</em>');
            
            // Code blocks
            html = html.replace(/```([\s\S]*?)```/g, '<pre style="background: var(--bg-tertiary); padding: 1rem; border-radius: var(--radius-md); border: 1px solid var(--border-primary); overflow-x: auto; margin: 1rem 0;"><code>$1</code></pre>');
            html = html.replace(/`([^`]+)`/g, '<code style="background: var(--bg-tertiary); padding: 0.25rem 0.5rem; border-radius: 4px; font-family: \'Courier New\', monospace; font-size: 0.9em; color: var(--accent-cyan); border: 1px solid var(--border-primary);">$1</code>');
            
            // Lists
            html = html.replace(/^\* (.+)$/gim, '<li style="margin: 0.5rem 0; padding-left: 0.5rem;">$1</li>');
            html = html.replace(/^(\d+)\. (.+)$/gim, '<li style="margin: 0.5rem 0; padding-left: 0.5rem; list-style: decimal;">$1. $2</li>');
            
            // Wrap consecutive list items in ul/ol
            html = html.replace(/(<li.*<\/li>\n?)+/g, '<ul style="margin: 1rem 0; padding-left: 1.5rem; list-style: disc; color: var(--text-secondary);">$&</ul>');
            
            // Links
            html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" style="color: var(--accent-cyan); text-decoration: none; border-bottom: 1px solid var(--accent-cyan); transition: all var(--transition-fast);" onmouseover="this.style.borderBottomColor=\'var(--accent-purple)\'" onmouseout="this.style.borderBottomColor=\'var(--accent-cyan)\'">$1</a>');
            
            // Line breaks
            html = html.replace(/\n\n/g, '</p><p style="margin: 0.75rem 0; line-height: 1.7;">');
            html = html.replace(/\n/g, '<br>');
            
            // Wrap in paragraph if not already wrapped
            if (!html.trim().startsWith('<')) {
                html = '<p style="margin: 0; line-height: 1.7;">' + html + '</p>';
            } else {
                html = '<div style="line-height: 1.7;">' + html + '</div>';
            }
            
            // Format currency amounts (₹ symbols)
            html = html.replace(/₹(\d+(?:,\d+)*(?:\.\d+)?)/g, '<span style="color: var(--accent-success); font-weight: 600;">₹$1</span>');
            
            return html;
        }

        function addMessage(sender, text, isUser = false, saveToHistory = true) {
            // Save message to chat data
            if (saveToHistory && currentChatId) {
                chatMessagesData.push({
                    sender: sender,
                    text: text,
                    isUser: isUser,
                    timestamp: Date.now()
                });
                
                // Auto-save after each message
                setTimeout(() => {
                    saveCurrentChat();
                }, 500);
            }
            
            // Add to DOM
            addMessageToDOM(sender, text, isUser, true);
        }

        function addMessageToDOM(sender, text, isUser = false, animate = true) {
            const chatMessages = document.getElementById('chatMessages');
            const welcomeCard = chatMessages.querySelector('.welcome-card');
            if (welcomeCard) {
                welcomeCard.remove();
            }
            // Mark that messages exist so the welcome card stays hidden
            chatMessages.classList.add('has-messages');

            // Remove any existing typing indicators
            const existingIndicators = chatMessages.querySelectorAll('.typing-indicator');
            existingIndicators.forEach(ind => ind.remove());

            const formattedText = markdownToHtml(text);
            
            // Create message group (ChatGPT style)
            const messageGroup = document.createElement('div');
            messageGroup.className = `message-group ${isUser ? 'user-message' : 'ai-message'}`;
            if (animate) {
                messageGroup.style.animation = 'slideInMessage 0.3s ease-out';
            }
            
            const messageGroupInner = document.createElement('div');
            messageGroupInner.className = 'message-group-inner';
            
            // Avatar
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.innerHTML = isUser ? '<i class="fas fa-user"></i>' : '<i class="fas fa-robot"></i>';
            
            // Content container
            const messageContentDiv = document.createElement('div');
            messageContentDiv.className = 'message-content';
            
            // Message bubble wrapper
            const messageBubble = document.createElement('div');
            messageBubble.className = 'message-bubble';
            
            // Sender name (for both AI and user messages)
            const senderDiv = document.createElement('div');
            senderDiv.className = 'message-sender';
            senderDiv.textContent = sender;
            messageBubble.appendChild(senderDiv);
            
            // Message text
            const textDiv = document.createElement('div');
            textDiv.className = 'message-text';
            textDiv.innerHTML = formattedText;
            messageBubble.appendChild(textDiv);
            
            // Action buttons (shown on hover) - moved BELOW the card
            const actions = document.createElement('div');
            actions.className = 'message-actions';
            
            const copyBtn = document.createElement('button');
            copyBtn.className = 'message-action-btn';
            copyBtn.title = 'Copy';
            copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
            copyBtn.onclick = () => copyToClipboard(text.replace(/`/g, '\\`').replace(/\$/g, '\\$').replace(/\\/g, '\\\\'));
            
            actions.appendChild(copyBtn);
            
            if (!isUser) {
                const likeBtn = document.createElement('button');
                likeBtn.className = 'message-action-btn';
                likeBtn.title = 'Good response';
                likeBtn.innerHTML = '<i class="far fa-thumbs-up"></i>';
                likeBtn.onclick = () => likeMessage(likeBtn);
                
                const dislikeBtn = document.createElement('button');
                dislikeBtn.className = 'message-action-btn';
                dislikeBtn.title = 'Bad response';
                dislikeBtn.innerHTML = '<i class="far fa-thumbs-down"></i>';
                dislikeBtn.onclick = () => dislikeMessage(dislikeBtn);
                
                actions.appendChild(likeBtn);
                actions.appendChild(dislikeBtn);
            }
            
            // Append bubble first, then actions below it
            messageContentDiv.appendChild(messageBubble);
            messageContentDiv.appendChild(actions);
            
            messageGroupInner.appendChild(avatar);
            messageGroupInner.appendChild(messageContentDiv);
            messageGroup.appendChild(messageGroupInner);
            
            chatMessages.appendChild(messageGroup);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function likeMessage(btn) {
            btn.innerHTML = '<i class="fas fa-thumbs-up"></i>';
            btn.style.color = 'var(--accent-cyan)';
            if (typeof toast !== 'undefined') {
                toast.success('Thanks for your feedback!', 2000);
            }
        }
        
        function dislikeMessage(btn) {
            btn.innerHTML = '<i class="fas fa-thumbs-down"></i>';
            btn.style.color = 'var(--error)';
            if (typeof toast !== 'undefined') {
                toast.info('Feedback noted', 2000);
            }
        }
        
        
        // Copy to clipboard function
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                toast.success('Copied to clipboard!', 2000);
            }).catch(() => {
                toast.error('Failed to copy');
            });
        }

        // Handle form submission
        document.getElementById('chatForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const messageInput = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');
            const message = messageInput.value.trim();
            
            if (!message) return;
            
            // Ensure welcome card is hidden immediately on first prompt
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.classList.add('has-messages');
            const wc = chatMessages.querySelector('.welcome-card');
            if (wc) wc.remove();

            // Disable input while sending
            messageInput.disabled = true;
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            // Hide suggestions after first message
            const suggestionsDiv = document.querySelector('.chat-input-suggestions');
            if (suggestionsDiv) {
                suggestionsDiv.style.display = 'none';
            }

            // Add user message
            addMessage('You', message, true);
            messageInput.value = '';
            messageInput.style.height = 'auto';

            // Activate loading bar
            const chatLoadingBar = document.getElementById('chatLoadingBar');
            if (chatLoadingBar) chatLoadingBar.classList.add('active');

            // Show typing indicator (ChatGPT style)
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'typing-indicator active';
            typingIndicator.id = 'typingIndicator';
            
            const typingGroup = document.createElement('div');
            typingGroup.className = 'typing-indicator-group';
            
            const typingInner = document.createElement('div');
            typingInner.className = 'typing-indicator-inner';
            
            const typingAvatar = document.createElement('div');
            typingAvatar.className = 'message-avatar';
            typingAvatar.style.background = 'linear-gradient(135deg, #19c37d 0%, #0fa968 100%)';
            typingAvatar.innerHTML = '<i class="fas fa-robot"></i>';
            
            const typingBubble = document.createElement('div');
            typingBubble.className = 'typing-indicator-bubble';
            
            const typingContent = document.createElement('div');
            typingContent.className = 'typing-indicator-content';
            typingContent.innerHTML = `
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            `;
            
            typingBubble.appendChild(typingContent);
            typingInner.appendChild(typingAvatar);
            typingInner.appendChild(typingBubble);
            typingGroup.appendChild(typingInner);
            typingIndicator.appendChild(typingGroup);
            
            chatMessages.appendChild(typingIndicator);
            
            // Scroll to show typing indicator
            setTimeout(() => {
                chatMessages.scrollTo({
                    top: chatMessages.scrollHeight,
                    behavior: 'smooth'
                });
            }, 100);

            // Send message to backend with abort controller for stop functionality
            let currentFetchController = new AbortController();
            window.currentFetchController = currentFetchController;

            // Show inline Stop button while generating
            const inlineStopBtn = document.getElementById('stopBtn');
            if (inlineStopBtn) {
                inlineStopBtn.style.display = 'inline-flex';
                inlineStopBtn.disabled = false;
                inlineStopBtn.onclick = () => {
                    if (window.currentFetchController) {
                        window.currentFetchController.abort();
                        window.currentFetchController = null;
                    }
                    const typingEl = document.getElementById('typingIndicator');
                    if (typingEl) typingEl.remove();
                    const lb = document.getElementById('chatLoadingBar');
                    if (lb) lb.classList.remove('active');
                    messageInput.disabled = false;
                    sendBtn.disabled = false;
                    sendBtn.innerHTML = '<i class="fas fa-arrow-up"></i>';
                    inlineStopBtn.style.display = 'none';
                    if (typeof toast !== 'undefined') { toast.info('Response stopped'); }
                };
            }
            
            const token = localStorage.getItem('token');
            fetch('/api/chat/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': token ? `Bearer ${token}` : ''
                },
                credentials: 'include',
                body: JSON.stringify({ message: message }),
                signal: currentFetchController.signal
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.error || err.message || 'Request failed');
                    });
                }
                return response.json();
            })
            .then(data => {
                // Remove typing indicator
                const typingInd = document.getElementById('typingIndicator');
                if (typingInd) typingInd.remove();
                
                // Deactivate loading bar
                if (chatLoadingBar) chatLoadingBar.classList.remove('active');
                
                messageInput.disabled = false;
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<i class="fas fa-arrow-up"></i>';
                const inlineStopBtn2 = document.getElementById('stopBtn');
                if (inlineStopBtn2) inlineStopBtn2.style.display = 'none';
                messageInput.focus();
                
                window.currentFetchController = null;
                
                if (data.message) {
                    addMessage('FinGenie AI', data.message, false);
                } else {
                    addMessage('FinGenie AI', 'Sorry, I encountered an error. Please try again.', false);
                }
            })
            .catch(error => {
                // Remove typing indicator
                const typingInd = document.getElementById('typingIndicator');
                if (typingInd) typingInd.remove();
                
                messageInput.disabled = false;
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<i class="fas fa-arrow-up"></i>';
                
                // Deactivate loading bar
                if (chatLoadingBar) chatLoadingBar.classList.remove('active');
                const inlineStopBtn3 = document.getElementById('stopBtn');
                if (inlineStopBtn3) inlineStopBtn3.style.display = 'none';
                
                // Don't show error if request was aborted
                if (error.name !== 'AbortError') {
                    console.error('Error:', error);
                    addMessage('FinGenie AI', `Error: ${error.message || 'Please try again.'}`, false);
                }
                
                window.currentFetchController = null;
            });
        });

        // Like message function
        function likeMessage(button) {
            const icon = button.querySelector('i');
            if (icon.classList.contains('far')) {
                icon.classList.remove('far');
                icon.classList.add('fas');
                button.style.color = 'var(--accent-cyan)';
                button.style.opacity = '1';
toast.success('Thanks for your feedback!', 2000);
            } else {
                icon.classList.remove('fas');
                icon.classList.add('far');
                button.style.color = '';
                button.style.opacity = '0.7';
            }
        }

        // Fix sidebar links - prevent default and navigate
        document.querySelectorAll('.sidebar .menu-item').forEach(item => {
            item.addEventListener('click', function(e) {
                const href = this.getAttribute('href');
                if (href === '#' || !href) {
                    const onclick = this.getAttribute('onclick');
                    if (onclick && onclick.includes('showPage')) {
                        e.preventDefault();
                        // Extract page name from onclick
                        const match = onclick.match(/showPage\(['"](.+?)['"]\)/);
                        if (match) {
                            showPage(match[1]);
                        }
                    }
                }
            });
        });

        // Helper function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Clear all chat history
        function clearAllChatHistory() {
            if (confirm('Are you sure you want to delete all chat history? This cannot be undone.')) {
                localStorage.removeItem('chatHistory');
                currentChatId = null;
                chatMessagesData = [];
                startNewChat();
toast.success('All chat history cleared');
            }
        }

        // Ensure chat history sidebar starts hidden and initialize chat
        document.addEventListener('DOMContentLoaded', function() {
            const chatSidebar = document.querySelector('.chat-sidebar');
            if (chatSidebar) {
                chatSidebar.classList.remove('active');
            }
            
            // Initialize chat history
            initializeChatHistory();
        });

        // Save chat before page unload
        window.addEventListener('beforeunload', function() {
            if (currentChatId && chatMessagesData.length > 0) {
                saveCurrentChat();
            }
        });

        // Logout handler - using apiRequest from main.js
        document.getElementById('logoutBtn').addEventListener('click', async function() {
            try {
                await apiRequest('/auth/logout', 'POST');
                localStorage.removeItem('token');
                window.location.href = '/login';
            } catch (error) {
                console.error('Error:', error);
                localStorage.removeItem('token');
                window.location.href = '/login';
            }
        });
    </script>
</body>
</html>
